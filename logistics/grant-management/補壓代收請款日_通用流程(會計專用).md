# 補壓代收請款日 - 通用流程(會計專用)

## 適用情境

當遇到以下情況時,需要手動補壓代收請款日(`CheckoutdaisouDate`):

1. ✅ **連假期間 WeeklySettlement 排程沒執行**
2. ✅ **核帳檔延遲提供,導致排程執行時訂單還沒有 ReconciliationResult='Y'**
3. ✅ **手動補單,需要補壓之前的代收請款日**

---

## 前置知識

### 1. 週三排程邏輯 (WeeklySettlement)

**執行時間**: 每週三凌晨 1:10
**處理範圍**: 週三往回推 9 天開始,持續 7 天

**範例**:
- 2025-10-01 (週三): 處理 9/22-9/29 的訂單 → 壓 `CheckoutdaisouDate = '2025-10-01'`
- 2025-10-08 (週三): 處理 9/29-10/6 的訂單 → 壓 `CheckoutdaisouDate = '2025-10-08'`
- 2025-10-15 (週三): 處理 10/6-10/13 的訂單 → 壓 `CheckoutdaisouDate = '2025-10-15'`

### 2. 代收請款的觸發條件

| 物流類型 | 觸發欄位 | 條件 |
|---------|---------|------|
| **C2C** (01,03,05,10,23) | `CheckoutDate` | respcode = '0101' (取貨門市已驗收) |
| **C2C冷凍** (21) | LogisticProcessHistory | respcode = '8000' (結案) |
| **大宗快撥** (02,04,22,24) | `CheckoutDate` + `advance_Granted='1'` | respcode = '0101' |

**共同條件**:
- `ReconciliationResult = 'Y'` (核帳通過)
- `Detail_Status_Description IN ('買家已取件', '消費者成功取件')` ← **重要!排除退貨**
- `CheckoutdaisouDate IS NULL` (尚未壓代收請款日)
- `GrantdaisouDate IS NULL` (尚未撥款)
- `Checkoutable = '1'` (可請款)
- `DeliverMode = '01'` (C2C模式)

---

## 執行步驟

### 步驟 0: 確認需要補壓的週次

**計算公式**:
- 週三日期往回推 9 天 = 起始日 (CheckoutDate >= 起始日)
- 週三日期往回推 2 天 = 結束日 (CheckoutDate < 結束日)

**範例**:
```
補壓日期: 2025-10-01 (週三)
起始日: 2025-10-01 - 9 = 2025-09-22
結束日: 2025-10-01 - 2 = 2025-09-29
查詢條件: CheckoutDate >= '2025-09-22' AND CheckoutDate < '2025-09-29'
```

---

### 步驟 1: 查詢需要補壓的訂單數量

#### 1-1. 一般 C2C + 大宗快撥 (01, 03, 05, 10, 23, 02快撥, 04快撥, 22快撥, 24快撥)

```sql
-- ========================================
-- 查詢:需要補壓的C2C訂單
-- ========================================
SELECT
    Logistic_service,
    COUNT(*) as 訂單數量,
    SUM(TotalAmount) as 代收款總額
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
WHERE oa.CheckoutDate >= '{起始日} 00:00:00'  -- 例如: 2025-09-22
    AND oa.CheckoutDate < '{結束日} 00:00:00'  -- 例如: 2025-09-29
    AND (
        -- C2C 交貨便/店到店
        oa.Logistic_service IN ('01','03','05','10','23')
        OR
        -- 大宗快撥
        (oa.Logistic_service IN ('02','04','22','24') AND oa.advance_Granted = '1')
    )
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oi.Detail_Status_Description IN ('買家已取件', '消費者成功取件')  -- ← 重要!排除退貨
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    )
GROUP BY Logistic_service
ORDER BY Logistic_service;
```

#### 1-2. 特殊 C2C - 21 (7-11冷凍C2C)

```sql
-- ========================================
-- 查詢:需要補壓的21冷凍訂單
-- ========================================
SELECT
    COUNT(*) as 訂單數量
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
INNER JOIN (
    SELECT DISTINCT
        CAST(LogisticNumber AS VARCHAR) AS LogisticNumber,
        CAST(paymentno AS VARCHAR) AS paymentno
    FROM LogisticProcessHistory
    WHERE datadatetime >= '{起始日} 00:00:00'  -- 例如: 2025-09-22
        AND datadatetime < '{結束日} 00:00:00'  -- 例如: 2025-09-29
        AND respcode = '8000'
        AND FileTitle = 'NPPS'
        AND LogisticServiceID = '21'
) lph
    ON oa.LogisticNumber = lph.LogisticNumber
    AND oa.paymentno = lph.paymentno
WHERE oa.Logistic_service = '21'
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oi.Detail_Status_Description IN ('買家已取件', '消費者成功取件')  -- ← 重要!排除退貨
    AND oa.CheckoutDate IS NULL
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    );
```

---

### 步驟 2: 執行補壓 (確認筆數無誤後)

#### 2-1. 更新一般 C2C + 大宗快撥

```sql
-- ========================================
-- 更新:補壓C2C代收請款日
-- ========================================
UPDATE oa
SET CheckoutdaisouDate = '{週三日期}'  -- 例如: 2025-10-01
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
WHERE oa.CheckoutDate >= '{起始日} 00:00:00'
    AND oa.CheckoutDate < '{結束日} 00:00:00'
    AND (
        oa.Logistic_service IN ('01','03','05','10','23')
        OR
        (oa.Logistic_service IN ('02','04','22','24') AND oa.advance_Granted = '1')
    )
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oi.Detail_Status_Description IN ('買家已取件', '消費者成功取件')  -- ← 重要!
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    );

-- 查看更新筆數
SELECT @@ROWCOUNT as 更新筆數;
```

#### 2-2. 更新 21 冷凍訂單

```sql
-- ========================================
-- 更新:補壓21冷凍代收請款日
-- ========================================
UPDATE oa
SET CheckoutdaisouDate = '{週三日期}'  -- 例如: 2025-10-01
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
INNER JOIN (
    SELECT DISTINCT
        CAST(LogisticNumber AS VARCHAR) AS LogisticNumber,
        CAST(paymentno AS VARCHAR) AS paymentno
    FROM LogisticProcessHistory
    WHERE datadatetime >= '{起始日} 00:00:00'
        AND datadatetime < '{結束日} 00:00:00'
        AND respcode = '8000'
        AND FileTitle = 'NPPS'
        AND LogisticServiceID = '21'
) lph
    ON oa.LogisticNumber = lph.LogisticNumber
    AND oa.paymentno = lph.paymentno
WHERE oa.Logistic_service = '21'
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oi.Detail_Status_Description IN ('買家已取件', '消費者成功取件')  -- ← 重要!
    AND oa.CheckoutDate IS NULL
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    );

-- 查看更新筆數
SELECT @@ROWCOUNT as 更新筆數;
```

---

### 步驟 3: 驗證更新結果

```sql
-- ========================================
-- 驗證:查看更新結果
-- ========================================
SELECT
    CheckoutdaisouDate,
    Logistic_service,
    COUNT(*) as 訂單數量,
    SUM(TotalAmount) as 代收款總額
FROM Order_Accounting
WHERE CheckoutdaisouDate = '{週三日期}'  -- 例如: 2025-10-01
GROUP BY CheckoutdaisouDate, Logistic_service
ORDER BY Logistic_service;
```

---

## 快速操作範例

### 範例:補壓 2025-10-22 (週三) 的代收請款日

**計算日期範圍**:
- 起始日: 2025-10-22 - 9 = 2025-10-13
- 結束日: 2025-10-22 - 2 = 2025-10-20
- 週三日期: 2025-10-22

**步驟 1: 查詢 C2C 筆數**
```sql
WHERE oa.CheckoutDate >= '2025-10-13 00:00:00'
    AND oa.CheckoutDate < '2025-10-20 00:00:00'
```

**步驟 2: 執行更新**
```sql
UPDATE oa
SET CheckoutdaisouDate = '2025-10-22'
WHERE oa.CheckoutDate >= '2025-10-13 00:00:00'
    AND oa.CheckoutDate < '2025-10-20 00:00:00'
    -- ... 其他條件
```

**步驟 3: 驗證**
```sql
WHERE CheckoutdaisouDate = '2025-10-22'
```

---

## 重要提醒

### ✅ 執行前檢查

1. **確認核帳檔已到**: 確保 `ReconciliationResult='Y'` 的訂單數量正確
2. **確認日期計算**: 起始日和結束日的計算要正確
3. **先用 SELECT 查詢**: 絕對不要直接執行 UPDATE,一定要先用 SELECT 確認筆數
4. **排除退貨訂單**: 務必加上 `Detail_Status_Description IN ('買家已取件', '消費者成功取件')`

### ⚠️ 常見錯誤

1. ❌ **忘記排除退貨** → 會誤撥退貨訂單的代收款
2. ❌ **日期範圍算錯** → 會壓到錯誤的訂單
3. ❌ **沒有先 SELECT** → 直接 UPDATE 可能更新錯誤資料
4. ❌ **21 用 CheckoutDate** → 21 要用 LogisticProcessHistory.datadatetime

### 📋 執行記錄範本

```
補壓日期: 2025-10-22
起始日: 2025-10-13
結束日: 2025-10-20
C2C訂單數: XXX 筆
21訂單數: XXX 筆
更新筆數: XXX 筆
執行人員: [姓名]
執行時間: 2025-10-XX XX:XX
```

---

## 後續動作

補壓完成後,在**下個週三執行撥款操作**時:
1. 系統會自動抓取 `CheckoutdaisouDate IS NOT NULL` 且 `GrantdaisouDate IS NULL` 的訂單
2. 執行 `Grant_AndC2CReport` 撥款功能
3. 系統會自動填入 `GrantdaisouDate`
4. 完成撥款流程

---

## 參考文件

- 「補壓代收請款日_完整步驟.md」- 包含詳細的分步驟說明
- 「補壓代收請款日_排除退貨版.md」- 包含排除退貨的完整 SQL
- 「2025-10-17_誤撥退貨訂單事件處理記錄.md」- 誤撥事件的處理案例

---

## 聯絡資訊

如有問題,請聯絡:
- **系統負責人**: [填寫]
- **技術支援**: [填寫]
