# è£œå£“ä»£æ”¶è«‹æ¬¾æ—¥ - é€šç”¨æµç¨‹(æœƒè¨ˆå°ˆç”¨)

## é©ç”¨æƒ…å¢ƒ

ç•¶é‡åˆ°ä»¥ä¸‹æƒ…æ³æ™‚,éœ€è¦æ‰‹å‹•è£œå£“ä»£æ”¶è«‹æ¬¾æ—¥(`CheckoutdaisouDate`):

1. âœ… **é€£å‡æœŸé–“ WeeklySettlement æ’ç¨‹æ²’åŸ·è¡Œ**
2. âœ… **æ ¸å¸³æª”å»¶é²æä¾›,å°è‡´æ’ç¨‹åŸ·è¡Œæ™‚è¨‚å–®é‚„æ²’æœ‰ ReconciliationResult='Y'**
3. âœ… **æ‰‹å‹•è£œå–®,éœ€è¦è£œå£“ä¹‹å‰çš„ä»£æ”¶è«‹æ¬¾æ—¥**

---

## å‰ç½®çŸ¥è­˜

### 1. é€±ä¸‰æ’ç¨‹é‚è¼¯ (WeeklySettlement)

**åŸ·è¡Œæ™‚é–“**: æ¯é€±ä¸‰å‡Œæ™¨ 1:10
**è™•ç†ç¯„åœ**: é€±ä¸‰å¾€å›æ¨ 9 å¤©é–‹å§‹,æŒçºŒ 7 å¤©

**ç¯„ä¾‹**:
- 2025-10-01 (é€±ä¸‰): è™•ç† 9/22-9/29 çš„è¨‚å–® â†’ å£“ `CheckoutdaisouDate = '2025-10-01'`
- 2025-10-08 (é€±ä¸‰): è™•ç† 9/29-10/6 çš„è¨‚å–® â†’ å£“ `CheckoutdaisouDate = '2025-10-08'`
- 2025-10-15 (é€±ä¸‰): è™•ç† 10/6-10/13 çš„è¨‚å–® â†’ å£“ `CheckoutdaisouDate = '2025-10-15'`

### 2. ä»£æ”¶è«‹æ¬¾çš„è§¸ç™¼æ¢ä»¶

| ç‰©æµé¡å‹ | è§¸ç™¼æ¬„ä½ | æ¢ä»¶ |
|---------|---------|------|
| **C2C** (01,03,05,10,23) | `CheckoutDate` | respcode = '0101' (å–è²¨é–€å¸‚å·²é©—æ”¶) |
| **C2Cå†·å‡** (21) | LogisticProcessHistory | respcode = '8000' (çµæ¡ˆ) |
| **å¤§å®—å¿«æ’¥** (02,04,22,24) | `CheckoutDate` + `advance_Granted='1'` | respcode = '0101' |

**å…±åŒæ¢ä»¶**:
- `ReconciliationResult = 'Y'` (æ ¸å¸³é€šé)
- `Detail_Status_Description IN ('è²·å®¶å·²å–ä»¶', 'æ¶ˆè²»è€…æˆåŠŸå–ä»¶')` â† **é‡è¦!æ’é™¤é€€è²¨**
- `CheckoutdaisouDate IS NULL` (å°šæœªå£“ä»£æ”¶è«‹æ¬¾æ—¥)
- `GrantdaisouDate IS NULL` (å°šæœªæ’¥æ¬¾)
- `Checkoutable = '1'` (å¯è«‹æ¬¾)
- `DeliverMode = '01'` (C2Cæ¨¡å¼)

---

## åŸ·è¡Œæ­¥é©Ÿ

### æ­¥é©Ÿ 0: ç¢ºèªéœ€è¦è£œå£“çš„é€±æ¬¡

**è¨ˆç®—å…¬å¼**:
- é€±ä¸‰æ—¥æœŸå¾€å›æ¨ 9 å¤© = èµ·å§‹æ—¥ (CheckoutDate >= èµ·å§‹æ—¥)
- é€±ä¸‰æ—¥æœŸå¾€å›æ¨ 2 å¤© = çµæŸæ—¥ (CheckoutDate < çµæŸæ—¥)

**ç¯„ä¾‹**:
```
è£œå£“æ—¥æœŸ: 2025-10-01 (é€±ä¸‰)
èµ·å§‹æ—¥: 2025-10-01 - 9 = 2025-09-22
çµæŸæ—¥: 2025-10-01 - 2 = 2025-09-29
æŸ¥è©¢æ¢ä»¶: CheckoutDate >= '2025-09-22' AND CheckoutDate < '2025-09-29'
```

---

### æ­¥é©Ÿ 1: æŸ¥è©¢éœ€è¦è£œå£“çš„è¨‚å–®æ•¸é‡

#### 1-1. ä¸€èˆ¬ C2C + å¤§å®—å¿«æ’¥ (01, 03, 05, 10, 23, 02å¿«æ’¥, 04å¿«æ’¥, 22å¿«æ’¥, 24å¿«æ’¥)

```sql
-- ========================================
-- æŸ¥è©¢:éœ€è¦è£œå£“çš„C2Cè¨‚å–®
-- ========================================
SELECT
    Logistic_service,
    COUNT(*) as è¨‚å–®æ•¸é‡,
    SUM(TotalAmount) as ä»£æ”¶æ¬¾ç¸½é¡
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
WHERE oa.CheckoutDate >= '{èµ·å§‹æ—¥} 00:00:00'  -- ä¾‹å¦‚: 2025-09-22
    AND oa.CheckoutDate < '{çµæŸæ—¥} 00:00:00'  -- ä¾‹å¦‚: 2025-09-29
    AND (
        -- C2C äº¤è²¨ä¾¿/åº—åˆ°åº—
        oa.Logistic_service IN ('01','03','05','10','23')
        OR
        -- å¤§å®—å¿«æ’¥
        (oa.Logistic_service IN ('02','04','22','24') AND oa.advance_Granted = '1')
    )
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oi.Detail_Status_Description IN ('è²·å®¶å·²å–ä»¶', 'æ¶ˆè²»è€…æˆåŠŸå–ä»¶')  -- â† é‡è¦!æ’é™¤é€€è²¨
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    )
GROUP BY Logistic_service
ORDER BY Logistic_service;
```

#### 1-2. ç‰¹æ®Š C2C - 21 (7-11å†·å‡C2C)

```sql
-- ========================================
-- æŸ¥è©¢:éœ€è¦è£œå£“çš„21å†·å‡è¨‚å–®
-- ========================================
SELECT
    COUNT(*) as è¨‚å–®æ•¸é‡
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
INNER JOIN (
    SELECT DISTINCT
        CAST(LogisticNumber AS VARCHAR) AS LogisticNumber,
        CAST(paymentno AS VARCHAR) AS paymentno
    FROM LogisticProcessHistory
    WHERE datadatetime >= '{èµ·å§‹æ—¥} 00:00:00'  -- ä¾‹å¦‚: 2025-09-22
        AND datadatetime < '{çµæŸæ—¥} 00:00:00'  -- ä¾‹å¦‚: 2025-09-29
        AND respcode = '8000'
        AND FileTitle = 'NPPS'
        AND LogisticServiceID = '21'
) lph
    ON oa.LogisticNumber = lph.LogisticNumber
    AND oa.paymentno = lph.paymentno
WHERE oa.Logistic_service = '21'
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oi.Detail_Status_Description IN ('è²·å®¶å·²å–ä»¶', 'æ¶ˆè²»è€…æˆåŠŸå–ä»¶')  -- â† é‡è¦!æ’é™¤é€€è²¨
    AND oa.CheckoutDate IS NULL
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    );
```

---

### æ­¥é©Ÿ 2: åŸ·è¡Œè£œå£“ (ç¢ºèªç­†æ•¸ç„¡èª¤å¾Œ)

#### 2-1. æ›´æ–°ä¸€èˆ¬ C2C + å¤§å®—å¿«æ’¥

```sql
-- ========================================
-- æ›´æ–°:è£œå£“C2Cä»£æ”¶è«‹æ¬¾æ—¥
-- ========================================
UPDATE oa
SET CheckoutdaisouDate = '{é€±ä¸‰æ—¥æœŸ}'  -- ä¾‹å¦‚: 2025-10-01
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
WHERE oa.CheckoutDate >= '{èµ·å§‹æ—¥} 00:00:00'
    AND oa.CheckoutDate < '{çµæŸæ—¥} 00:00:00'
    AND (
        oa.Logistic_service IN ('01','03','05','10','23')
        OR
        (oa.Logistic_service IN ('02','04','22','24') AND oa.advance_Granted = '1')
    )
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oi.Detail_Status_Description IN ('è²·å®¶å·²å–ä»¶', 'æ¶ˆè²»è€…æˆåŠŸå–ä»¶')  -- â† é‡è¦!
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    );

-- æŸ¥çœ‹æ›´æ–°ç­†æ•¸
SELECT @@ROWCOUNT as æ›´æ–°ç­†æ•¸;
```

#### 2-2. æ›´æ–° 21 å†·å‡è¨‚å–®

```sql
-- ========================================
-- æ›´æ–°:è£œå£“21å†·å‡ä»£æ”¶è«‹æ¬¾æ—¥
-- ========================================
UPDATE oa
SET CheckoutdaisouDate = '{é€±ä¸‰æ—¥æœŸ}'  -- ä¾‹å¦‚: 2025-10-01
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
INNER JOIN (
    SELECT DISTINCT
        CAST(LogisticNumber AS VARCHAR) AS LogisticNumber,
        CAST(paymentno AS VARCHAR) AS paymentno
    FROM LogisticProcessHistory
    WHERE datadatetime >= '{èµ·å§‹æ—¥} 00:00:00'
        AND datadatetime < '{çµæŸæ—¥} 00:00:00'
        AND respcode = '8000'
        AND FileTitle = 'NPPS'
        AND LogisticServiceID = '21'
) lph
    ON oa.LogisticNumber = lph.LogisticNumber
    AND oa.paymentno = lph.paymentno
WHERE oa.Logistic_service = '21'
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oi.Detail_Status_Description IN ('è²·å®¶å·²å–ä»¶', 'æ¶ˆè²»è€…æˆåŠŸå–ä»¶')  -- â† é‡è¦!
    AND oa.CheckoutDate IS NULL
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    );

-- æŸ¥çœ‹æ›´æ–°ç­†æ•¸
SELECT @@ROWCOUNT as æ›´æ–°ç­†æ•¸;
```

---

### æ­¥é©Ÿ 3: é©—è­‰æ›´æ–°çµæœ

```sql
-- ========================================
-- é©—è­‰:æŸ¥çœ‹æ›´æ–°çµæœ
-- ========================================
SELECT
    CheckoutdaisouDate,
    Logistic_service,
    COUNT(*) as è¨‚å–®æ•¸é‡,
    SUM(TotalAmount) as ä»£æ”¶æ¬¾ç¸½é¡
FROM Order_Accounting
WHERE CheckoutdaisouDate = '{é€±ä¸‰æ—¥æœŸ}'  -- ä¾‹å¦‚: 2025-10-01
GROUP BY CheckoutdaisouDate, Logistic_service
ORDER BY Logistic_service;
```

---

## å¿«é€Ÿæ“ä½œç¯„ä¾‹

### ç¯„ä¾‹:è£œå£“ 2025-10-22 (é€±ä¸‰) çš„ä»£æ”¶è«‹æ¬¾æ—¥

**è¨ˆç®—æ—¥æœŸç¯„åœ**:
- èµ·å§‹æ—¥: 2025-10-22 - 9 = 2025-10-13
- çµæŸæ—¥: 2025-10-22 - 2 = 2025-10-20
- é€±ä¸‰æ—¥æœŸ: 2025-10-22

**æ­¥é©Ÿ 1: æŸ¥è©¢ C2C ç­†æ•¸**
```sql
WHERE oa.CheckoutDate >= '2025-10-13 00:00:00'
    AND oa.CheckoutDate < '2025-10-20 00:00:00'
```

**æ­¥é©Ÿ 2: åŸ·è¡Œæ›´æ–°**
```sql
UPDATE oa
SET CheckoutdaisouDate = '2025-10-22'
WHERE oa.CheckoutDate >= '2025-10-13 00:00:00'
    AND oa.CheckoutDate < '2025-10-20 00:00:00'
    -- ... å…¶ä»–æ¢ä»¶
```

**æ­¥é©Ÿ 3: é©—è­‰**
```sql
WHERE CheckoutdaisouDate = '2025-10-22'
```

---

## é‡è¦æé†’

### âœ… åŸ·è¡Œå‰æª¢æŸ¥

1. **ç¢ºèªæ ¸å¸³æª”å·²åˆ°**: ç¢ºä¿ `ReconciliationResult='Y'` çš„è¨‚å–®æ•¸é‡æ­£ç¢º
2. **ç¢ºèªæ—¥æœŸè¨ˆç®—**: èµ·å§‹æ—¥å’ŒçµæŸæ—¥çš„è¨ˆç®—è¦æ­£ç¢º
3. **å…ˆç”¨ SELECT æŸ¥è©¢**: çµ•å°ä¸è¦ç›´æ¥åŸ·è¡Œ UPDATE,ä¸€å®šè¦å…ˆç”¨ SELECT ç¢ºèªç­†æ•¸
4. **æ’é™¤é€€è²¨è¨‚å–®**: å‹™å¿…åŠ ä¸Š `Detail_Status_Description IN ('è²·å®¶å·²å–ä»¶', 'æ¶ˆè²»è€…æˆåŠŸå–ä»¶')`

### âš ï¸ å¸¸è¦‹éŒ¯èª¤

1. âŒ **å¿˜è¨˜æ’é™¤é€€è²¨** â†’ æœƒèª¤æ’¥é€€è²¨è¨‚å–®çš„ä»£æ”¶æ¬¾
2. âŒ **æ—¥æœŸç¯„åœç®—éŒ¯** â†’ æœƒå£“åˆ°éŒ¯èª¤çš„è¨‚å–®
3. âŒ **æ²’æœ‰å…ˆ SELECT** â†’ ç›´æ¥ UPDATE å¯èƒ½æ›´æ–°éŒ¯èª¤è³‡æ–™
4. âŒ **21 ç”¨ CheckoutDate** â†’ 21 è¦ç”¨ LogisticProcessHistory.datadatetime

### ğŸ“‹ åŸ·è¡Œè¨˜éŒ„ç¯„æœ¬

```
è£œå£“æ—¥æœŸ: 2025-10-22
èµ·å§‹æ—¥: 2025-10-13
çµæŸæ—¥: 2025-10-20
C2Cè¨‚å–®æ•¸: XXX ç­†
21è¨‚å–®æ•¸: XXX ç­†
æ›´æ–°ç­†æ•¸: XXX ç­†
åŸ·è¡Œäººå“¡: [å§“å]
åŸ·è¡Œæ™‚é–“: 2025-10-XX XX:XX
```

---

## å¾ŒçºŒå‹•ä½œ

è£œå£“å®Œæˆå¾Œ,åœ¨**ä¸‹å€‹é€±ä¸‰åŸ·è¡Œæ’¥æ¬¾æ“ä½œ**æ™‚:
1. ç³»çµ±æœƒè‡ªå‹•æŠ“å– `CheckoutdaisouDate IS NOT NULL` ä¸” `GrantdaisouDate IS NULL` çš„è¨‚å–®
2. åŸ·è¡Œ `Grant_AndC2CReport` æ’¥æ¬¾åŠŸèƒ½
3. ç³»çµ±æœƒè‡ªå‹•å¡«å…¥ `GrantdaisouDate`
4. å®Œæˆæ’¥æ¬¾æµç¨‹

---

## åƒè€ƒæ–‡ä»¶

- ã€Œè£œå£“ä»£æ”¶è«‹æ¬¾æ—¥_å®Œæ•´æ­¥é©Ÿ.mdã€- åŒ…å«è©³ç´°çš„åˆ†æ­¥é©Ÿèªªæ˜
- ã€Œè£œå£“ä»£æ”¶è«‹æ¬¾æ—¥_æ’é™¤é€€è²¨ç‰ˆ.mdã€- åŒ…å«æ’é™¤é€€è²¨çš„å®Œæ•´ SQL
- ã€Œ2025-10-17_èª¤æ’¥é€€è²¨è¨‚å–®äº‹ä»¶è™•ç†è¨˜éŒ„.mdã€- èª¤æ’¥äº‹ä»¶çš„è™•ç†æ¡ˆä¾‹

---

## è¯çµ¡è³‡è¨Š

å¦‚æœ‰å•é¡Œ,è«‹è¯çµ¡:
- **ç³»çµ±è² è²¬äºº**: [å¡«å¯«]
- **æŠ€è¡“æ”¯æ´**: [å¡«å¯«]
