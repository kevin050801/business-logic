# 補壓代收請款日 - 排除退貨訂單版

## 📋 說明

此為修正版的補壓代收請款日 SQL,**已加入排除退貨訂單的邏輯**,避免再次發生誤撥。

**修正重點**:
- ✅ 只壓「買家已取件」或「消費者成功取件」的訂單
- ✅ 排除所有退貨、取消、逾期等異常狀態的訂單
- ✅ 適用於 C2C、大宗快撥、7-11冷凍C2C(21) 所有服務

---

## 步驟 0:總覽查詢 - 確認需要補壓的訂單(已排除退貨)

### 查詢一般 C2C + 大宗快撥

```sql
-- ========================================
-- 總覽 - 查詢所有需要補壓代收請款日的訂單(排除退貨)
-- ========================================
SELECT
    CASE
        WHEN oa.CheckoutDate >= '2025-09-22' AND oa.CheckoutDate < '2025-09-29' THEN '2025-10-01'
        WHEN oa.CheckoutDate >= '2025-09-29' AND oa.CheckoutDate < '2025-10-06' THEN '2025-10-08'
        WHEN oa.CheckoutDate >= '2025-10-06' AND oa.CheckoutDate < '2025-10-13' THEN '2025-10-15'
        ELSE NULL
    END AS ShouldCheckoutDaisouDate,
    Logistic_service,
    CASE
        WHEN Logistic_service IN ('01','03','05','10','23') THEN 'C2C交貨便'
        WHEN Logistic_service IN ('02','04','22','24') THEN '大宗快撥'
        ELSE '其他'
    END AS ServiceType,
    COUNT(*) as OrderCount,
    SUM(TotalAmount) as TotalAmount
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
WHERE oa.CheckoutDate >= '2025-09-22 00:00:00'
    AND oa.CheckoutDate < '2025-10-13 00:00:00'
    AND (
        -- C2C 交貨便/店到店(排除21)
        oa.Logistic_service IN ('01','03','05','10','23')
        OR
        -- 大宗快撥
        (oa.Logistic_service IN ('02','04','22','24') AND oa.advance_Granted = '1')
    )
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    -- ★★★ 重點:只壓正常取件的訂單 ★★★
    AND oi.Detail_Status_Description IN ('買家已取件', '消費者成功取件')
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    )
GROUP BY
    CASE
        WHEN oa.CheckoutDate >= '2025-09-22' AND oa.CheckoutDate < '2025-09-29' THEN '2025-10-01'
        WHEN oa.CheckoutDate >= '2025-09-29' AND oa.CheckoutDate < '2025-10-06' THEN '2025-10-08'
        WHEN oa.CheckoutDate >= '2025-10-06' AND oa.CheckoutDate < '2025-10-13' THEN '2025-10-15'
        ELSE NULL
    END,
    Logistic_service
ORDER BY ShouldCheckoutDaisouDate, Logistic_service;
```

### 查詢 21 (7-11冷凍C2C)

```sql
-- ========================================
-- 總覽 - 查詢 21 (7-11冷凍C2C) 需要補壓的訂單(排除退貨)
-- ========================================
SELECT
    CASE
        WHEN lph.datadatetime >= '2025-09-22' AND lph.datadatetime < '2025-09-29' THEN '2025-10-01'
        WHEN lph.datadatetime >= '2025-09-29' AND lph.datadatetime < '2025-10-06' THEN '2025-10-08'
        WHEN lph.datadatetime >= '2025-10-06' AND lph.datadatetime < '2025-10-13' THEN '2025-10-15'
        ELSE NULL
    END AS ShouldCheckoutDaisouDate,
    COUNT(*) as OrderCount,
    SUM(oa.TotalAmount) as TotalAmount
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
INNER JOIN (
    SELECT DISTINCT
        CAST(LogisticNumber AS VARCHAR) AS LogisticNumber,
        CAST(paymentno AS VARCHAR) AS paymentno,
        datadatetime
    FROM LogisticProcessHistory
    WHERE datadatetime >= '2025-09-22 00:00:00'
        AND datadatetime < '2025-10-13 00:00:00'
        AND respcode = '8000'
        AND FileTitle = 'NPPS'
        AND LogisticServiceID = '21'
) lph
    ON oa.LogisticNumber = lph.LogisticNumber
    AND oa.paymentno = lph.paymentno
WHERE oa.Logistic_service = '21'
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oa.CheckoutDate IS NULL
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    -- ★★★ 重點:只壓正常取件的訂單 ★★★
    AND oi.Detail_Status_Description IN ('買家已取件', '消費者成功取件')
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    )
GROUP BY
    CASE
        WHEN lph.datadatetime >= '2025-09-22' AND lph.datadatetime < '2025-09-29' THEN '2025-10-01'
        WHEN lph.datadatetime >= '2025-09-29' AND lph.datadatetime < '2025-10-06' THEN '2025-10-08'
        WHEN lph.datadatetime >= '2025-10-06' AND lph.datadatetime < '2025-10-13' THEN '2025-10-15'
        ELSE NULL
    END
ORDER BY ShouldCheckoutDaisouDate;
```

---

## 步驟 1:補壓 10/1 的代收請款日(一般 C2C + 大宗快撥)

### 1-1. 先查詢確認筆數

```sql
-- ========================================
-- SELECT - 10/1 應該壓的代收請款(9/22-9/28) - 排除退貨
-- ========================================
SELECT
    COUNT(*) as TotalRows,
    Logistic_service,
    COUNT(*) as ServiceCount
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
WHERE oa.CheckoutDate >= '2025-09-22 00:00:00'
    AND oa.CheckoutDate < '2025-09-29 00:00:00'
    AND (
        oa.Logistic_service IN ('01','03','05','10','23')
        OR
        (oa.Logistic_service IN ('02','04','22','24') AND oa.advance_Granted = '1')
    )
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    -- ★★★ 排除退貨/異常訂單 ★★★
    AND oi.Detail_Status_Description IN ('買家已取件', '消費者成功取件')
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    )
GROUP BY Logistic_service;
```

### 1-2. 確認無誤後執行更新

```sql
-- ========================================
-- UPDATE - 10/1 應該壓的代收請款(9/22-9/28) - 排除退貨
-- ========================================
UPDATE oa
SET CheckoutdaisouDate = '2025-10-01'
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
WHERE oa.CheckoutDate >= '2025-09-22 00:00:00'
    AND oa.CheckoutDate < '2025-09-29 00:00:00'
    AND (
        -- C2C 交貨便/店到店
        oa.Logistic_service IN ('01','03','05','10','23')
        OR
        -- 大宗快撥
        (oa.Logistic_service IN ('02','04','22','24') AND oa.advance_Granted = '1')
    )
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    -- ★★★ 排除退貨/異常訂單 ★★★
    AND oi.Detail_Status_Description IN ('買家已取件', '消費者成功取件')
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    );

-- 查看更新筆數
SELECT @@ROWCOUNT as UpdatedRows;
```

---

## 步驟 2:補壓 10/8 的代收請款日(一般 C2C + 大宗快撥)

### 2-1. 先查詢確認筆數

```sql
-- ========================================
-- SELECT - 10/8 應該壓的代收請款(9/29-10/5) - 排除退貨
-- ========================================
SELECT
    COUNT(*) as TotalRows,
    Logistic_service,
    COUNT(*) as ServiceCount
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
WHERE oa.CheckoutDate >= '2025-09-29 00:00:00'
    AND oa.CheckoutDate < '2025-10-06 00:00:00'
    AND (
        oa.Logistic_service IN ('01','03','05','10','23')
        OR
        (oa.Logistic_service IN ('02','04','22','24') AND oa.advance_Granted = '1')
    )
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    -- ★★★ 排除退貨/異常訂單 ★★★
    AND oi.Detail_Status_Description IN ('買家已取件', '消費者成功取件')
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    )
GROUP BY Logistic_service;
```

### 2-2. 確認無誤後執行更新

```sql
-- ========================================
-- UPDATE - 10/8 應該壓的代收請款(9/29-10/5) - 排除退貨
-- ========================================
UPDATE oa
SET CheckoutdaisouDate = '2025-10-08'
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
WHERE oa.CheckoutDate >= '2025-09-29 00:00:00'
    AND oa.CheckoutDate < '2025-10-06 00:00:00'
    AND (
        -- C2C 交貨便/店到店
        oa.Logistic_service IN ('01','03','05','10','23')
        OR
        -- 大宗快撥
        (oa.Logistic_service IN ('02','04','22','24') AND oa.advance_Granted = '1')
    )
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    -- ★★★ 排除退貨/異常訂單 ★★★
    AND oi.Detail_Status_Description IN ('買家已取件', '消費者成功取件')
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    );

-- 查看更新筆數
SELECT @@ROWCOUNT as UpdatedRows;
```

---

## 步驟 3:補壓 10/15 的代收請款日(一般 C2C + 大宗快撥)

### 3-1. 先查詢確認筆數

```sql
-- ========================================
-- SELECT - 10/15 應該壓的代收請款(10/6-10/12) - 排除退貨
-- ========================================
SELECT
    COUNT(*) as TotalRows,
    Logistic_service,
    COUNT(*) as ServiceCount
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
WHERE oa.CheckoutDate >= '2025-10-06 00:00:00'
    AND oa.CheckoutDate < '2025-10-13 00:00:00'
    AND (
        oa.Logistic_service IN ('01','03','05','10','23')
        OR
        (oa.Logistic_service IN ('02','04','22','24') AND oa.advance_Granted = '1')
    )
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    -- ★★★ 排除退貨/異常訂單 ★★★
    AND oi.Detail_Status_Description IN ('買家已取件', '消費者成功取件')
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    )
GROUP BY Logistic_service;
```

### 3-2. 確認無誤後執行更新

```sql
-- ========================================
-- UPDATE - 10/15 應該壓的代收請款(10/6-10/12) - 排除退貨
-- ========================================
UPDATE oa
SET CheckoutdaisouDate = '2025-10-15'
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
WHERE oa.CheckoutDate >= '2025-10-06 00:00:00'
    AND oa.CheckoutDate < '2025-10-13 00:00:00'
    AND (
        oa.Logistic_service IN ('01','03','05','10','23')
        OR
        (oa.Logistic_service IN ('02','04','22','24') AND oa.advance_Granted = '1')
    )
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    -- ★★★ 排除退貨/異常訂單 ★★★
    AND oi.Detail_Status_Description IN ('買家已取件', '消費者成功取件')
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    );

-- 查看更新筆數
SELECT @@ROWCOUNT as UpdatedRows;
```

---

## 步驟 4:補壓 10/1 的代收請款日(21 - 7-11冷凍C2C)

### 4-1. 先查詢確認筆數

```sql
-- ========================================
-- SELECT - 21 補壓 10/1 的代收請款(物流歷程時間在 9/22-9/28) - 排除退貨
-- ========================================
SELECT
    COUNT(*) as TotalRows
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
INNER JOIN (
    SELECT DISTINCT
        CAST(LogisticNumber AS VARCHAR) AS LogisticNumber,
        CAST(paymentno AS VARCHAR) AS paymentno
    FROM LogisticProcessHistory
    WHERE datadatetime >= '2025-09-22 00:00:00'
        AND datadatetime < '2025-09-29 00:00:00'
        AND respcode = '8000'
        AND FileTitle = 'NPPS'
        AND LogisticServiceID = '21'
) lph
    ON oa.LogisticNumber = lph.LogisticNumber
    AND oa.paymentno = lph.paymentno
WHERE oa.Logistic_service = '21'
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oa.CheckoutDate IS NULL
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    -- ★★★ 排除退貨/異常訂單 ★★★
    AND oi.Detail_Status_Description IN ('買家已取件', '消費者成功取件')
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    );
```

### 4-2. 確認無誤後執行更新

```sql
-- ========================================
-- UPDATE - 21 補壓 10/1 的代收請款(物流歷程時間在 9/22-9/28) - 排除退貨
-- ========================================
UPDATE oa
SET CheckoutdaisouDate = '2025-10-01'
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
INNER JOIN (
    SELECT DISTINCT
        CAST(LogisticNumber AS VARCHAR) AS LogisticNumber,
        CAST(paymentno AS VARCHAR) AS paymentno
    FROM LogisticProcessHistory
    WHERE datadatetime >= '2025-09-22 00:00:00'
        AND datadatetime < '2025-09-29 00:00:00'
        AND respcode = '8000'
        AND FileTitle = 'NPPS'
        AND LogisticServiceID = '21'
) lph
    ON oa.LogisticNumber = lph.LogisticNumber
    AND oa.paymentno = lph.paymentno
WHERE oa.Logistic_service = '21'
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oa.CheckoutDate IS NULL
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    -- ★★★ 排除退貨/異常訂單 ★★★
    AND oi.Detail_Status_Description IN ('買家已取件', '消費者成功取件')
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    );

-- 查看更新筆數
SELECT @@ROWCOUNT as UpdatedRows;
```

---

## 步驟 5:補壓 10/8 的代收請款日(21 - 7-11冷凍C2C)

### 5-1. 先查詢確認筆數

```sql
-- ========================================
-- SELECT - 21 補壓 10/8 的代收請款(物流歷程時間在 9/29-10/5) - 排除退貨
-- ========================================
SELECT
    COUNT(*) as TotalRows
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
INNER JOIN (
    SELECT DISTINCT
        CAST(LogisticNumber AS VARCHAR) AS LogisticNumber,
        CAST(paymentno AS VARCHAR) AS paymentno
    FROM LogisticProcessHistory
    WHERE datadatetime >= '2025-09-29 00:00:00'
        AND datadatetime < '2025-10-06 00:00:00'
        AND respcode = '8000'
        AND FileTitle = 'NPPS'
        AND LogisticServiceID = '21'
) lph
    ON oa.LogisticNumber = lph.LogisticNumber
    AND oa.paymentno = lph.paymentno
WHERE oa.Logistic_service = '21'
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oa.CheckoutDate IS NULL
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    -- ★★★ 排除退貨/異常訂單 ★★★
    AND oi.Detail_Status_Description IN ('買家已取件', '消費者成功取件')
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    );
```

### 5-2. 確認無誤後執行更新

```sql
-- ========================================
-- UPDATE - 21 補壓 10/8 的代收請款(物流歷程時間在 9/29-10/5) - 排除退貨
-- ========================================
UPDATE oa
SET CheckoutdaisouDate = '2025-10-08'
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
INNER JOIN (
    SELECT DISTINCT
        CAST(LogisticNumber AS VARCHAR) AS LogisticNumber,
        CAST(paymentno AS VARCHAR) AS paymentno
    FROM LogisticProcessHistory
    WHERE datadatetime >= '2025-09-29 00:00:00'
        AND datadatetime < '2025-10-06 00:00:00'
        AND respcode = '8000'
        AND FileTitle = 'NPPS'
        AND LogisticServiceID = '21'
) lph
    ON oa.LogisticNumber = lph.LogisticNumber
    AND oa.paymentno = lph.paymentno
WHERE oa.Logistic_service = '21'
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oa.CheckoutDate IS NULL
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    -- ★★★ 排除退貨/異常訂單 ★★★
    AND oi.Detail_Status_Description IN ('買家已取件', '消費者成功取件')
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    );

-- 查看更新筆數
SELECT @@ROWCOUNT as UpdatedRows;
```

---

## 步驟 6:補壓 10/15 的代收請款日(21 - 7-11冷凍C2C)

### 6-1. 先查詢確認筆數

```sql
-- ========================================
-- SELECT - 21 補壓 10/15 的代收請款(物流歷程時間在 10/6-10/12) - 排除退貨
-- ========================================
SELECT
    COUNT(*) as TotalRows
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
INNER JOIN (
    SELECT DISTINCT
        CAST(LogisticNumber AS VARCHAR) AS LogisticNumber,
        CAST(paymentno AS VARCHAR) AS paymentno
    FROM LogisticProcessHistory
    WHERE datadatetime >= '2025-10-06 00:00:00'
        AND datadatetime < '2025-10-13 00:00:00'
        AND respcode = '8000'
        AND FileTitle = 'NPPS'
        AND LogisticServiceID = '21'
) lph
    ON oa.LogisticNumber = lph.LogisticNumber
    AND oa.paymentno = lph.paymentno
WHERE oa.Logistic_service = '21'
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oa.CheckoutDate IS NULL
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    -- ★★★ 排除退貨/異常訂單 ★★★
    AND oi.Detail_Status_Description IN ('買家已取件', '消費者成功取件')
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    );
```

### 6-2. 確認無誤後執行更新

```sql
-- ========================================
-- UPDATE - 21 補壓 10/15 的代收請款(物流歷程時間在 10/6-10/12) - 排除退貨
-- ========================================
UPDATE oa
SET CheckoutdaisouDate = '2025-10-15'
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
INNER JOIN (
    SELECT DISTINCT
        CAST(LogisticNumber AS VARCHAR) AS LogisticNumber,
        CAST(paymentno AS VARCHAR) AS paymentno
    FROM LogisticProcessHistory
    WHERE datadatetime >= '2025-10-06 00:00:00'
        AND datadatetime < '2025-10-13 00:00:00'
        AND respcode = '8000'
        AND FileTitle = 'NPPS'
        AND LogisticServiceID = '21'
) lph
    ON oa.LogisticNumber = lph.LogisticNumber
    AND oa.paymentno = lph.paymentno
WHERE oa.Logistic_service = '21'
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oa.CheckoutDate IS NULL
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    -- ★★★ 排除退貨/異常訂單 ★★★
    AND oi.Detail_Status_Description IN ('買家已取件', '消費者成功取件')
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    );

-- 查看更新筆數
SELECT @@ROWCOUNT as UpdatedRows;
```

---

## 步驟 7:驗證更新結果

```sql
-- ========================================
-- 驗證 - 查看更新結果(分物流類型和日期)
-- ========================================
SELECT
    CheckoutdaisouDate,
    Logistic_service,
    CASE
        WHEN Logistic_service IN ('01','03','05','10','23') THEN 'C2C交貨便'
        WHEN Logistic_service = '21' THEN 'C2C冷凍(21)'
        WHEN Logistic_service IN ('02','04','22','24') THEN '大宗快撥'
        ELSE '其他'
    END AS ServiceType,
    advance_Granted,
    COUNT(*) as OrderCount,
    SUM(TotalAmount) as TotalAmount
FROM Order_Accounting
WHERE CheckoutdaisouDate IN ('2025-10-01', '2025-10-08', '2025-10-15')
    AND (
        Logistic_service IN ('01','03','05','10','21','23')
        OR
        (Logistic_service IN ('02','04','22','24') AND advance_Granted = '1')
    )
GROUP BY CheckoutdaisouDate, Logistic_service, advance_Granted
ORDER BY CheckoutdaisouDate, Logistic_service;
```

---

## ⚠️ 重要提醒

### 與原版的差異

**原版** (補壓代收請款日_完整步驟.md):
- ❌ 沒有檢查 `Detail_Status_Description`
- ❌ 會壓到退貨、取消、逾期等異常訂單

**修正版** (本文件):
- ✅ 加入 `AND oi.Detail_Status_Description IN ('買家已取件', '消費者成功取件')`
- ✅ 只壓正常取件的訂單
- ✅ 避免誤撥代收款給異常訂單

### 適用時機

- ✅ **未來所有的補壓作業都應使用此版本**
- ✅ 可整合到 `WeeklySettlement` 自動排程中
- ✅ 手動補壓時務必使用此版本

### 後續建議

建議將此邏輯整合到系統排程中,修改 `WeeklySettlement` 的 SQL:
```sql
-- 在壓 CheckoutdaisouDate 時加入
AND oi.Detail_Status_Description IN ('買家已取件', '消費者成功取件')
```
