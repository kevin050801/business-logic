# é€€è²¨èª¤æ’¥ - æ¬ è²»èˆ‡çµç®—è™•ç†æ–¹æ¡ˆ

## ğŸ“‹ ç¾æœ‰æ©Ÿåˆ¶èªªæ˜

### 1. å‰æœŸæ¬ è²»(Grant_History)æ©Ÿåˆ¶

**è³‡æ–™è¡¨**: `Grant_History`

**ç”¨é€”**: è¨˜éŒ„æ’¥æ¬¾é‡‘é¡ç‚º**è² æ•¸**çš„å•†å®¶æ¬ è²»

**é‹ä½œæµç¨‹**:
```csharp
// OrderController.cs ç¬¬ 1388-1414 è¡Œ
if (Convert.ToInt32(obj_grant_result.GrantTotalAmount) > 0)
{
    // æª¢æŸ¥æ˜¯å¦æœ‰å‰æœŸæœªçµç®—è² æ•¸å¸³æ¬¾
    if (Obj_Grant_HistoryresultList.Count > 0)
    {
        // æ¯”å°å•†å®¶(user_account + bank_code + bank_branch_code + bank_account)
        var Obj_Grant_resultlist2 = Obj_Grant_HistoryresultList
            .Where(c => c.user_account == obj_grant_result.user_account)
            .Where(c => c.bank_code == obj_grant_result.bank_code)
            .Where(c => c.bank_branch_code == obj_grant_result.bank_branch_code)
            .Where(c => c.bank_account == obj_grant_result.bank_account);

        // å¦‚æœå•†å®¶æœ‰æ¬ æ¬¾
        if (Obj_Grant_resultlist2.Count() > 0)
        {
            foreach (Obj_Grant_result obj_Historygrant_result in Obj_Grant_resultlist2)
            {
                // ç´¯åŠ å•†å®¶æ¬ æ¬¾é‡‘é¡ (è² æ•¸)
                Grant_deductAmount += Convert.ToInt32(obj_Historygrant_result.GrantTotalAmount);
            }
        }
    }

    if (Grant_deductAmount < 0)
    {
        // å‰æœŸæœªç¹³çµç®—æœå‹™è²»,å¾æœ¬æ¬¡æ’¥æ¬¾æ‰£é™¤
        GrantTotalAmount = Convert.ToInt32(obj_grant_result.GrantTotalAmount) + Grant_deductAmount;
        obj_grant_result.Grant_deductAmount = Grant_deductAmount.ToString();
    }
    else
    {
        // æ²’æœ‰å‰æœŸæœªç¹³çµç®—æœå‹™è²»
        GrantTotalAmount = Convert.ToInt32(obj_grant_result.GrantTotalAmount);
        obj_grant_result.Grant_deductAmount = "0";
    }
}
```

**é—œéµé‚è¼¯**:
1. æ¯æ¬¡æ’¥æ¬¾æ™‚,æŸ¥è©¢ `Sel_Grant_History()` SP å–å¾—æœ‰æ¬ è²»çš„å•†å®¶
2. å¦‚æœå•†å®¶æœ¬æ¬¡æ’¥æ¬¾é‡‘é¡ > 0,ä¸”æœ‰å‰æœŸæ¬ è²»(è² æ•¸)
3. è‡ªå‹•å¾æœ¬æ¬¡æ’¥æ¬¾æ‰£é™¤å‰æœŸæ¬ è²»: `å¯¦æ’¥æ¬¾ = æ‡‰æ’¥æ¬¾ + å‰æœŸæ¬ è²»(è² æ•¸)`
4. ç¯„ä¾‹: æ‡‰æ’¥ 10,000,å‰æœŸæ¬  -3,000,å¯¦æ’¥ = 10,000 + (-3,000) = 7,000

### 2. çµç®—æ‰£é¡åº¦æ©Ÿåˆ¶

**é‹ä½œæ™‚æ©Ÿ**: æ’¥æ¬¾å®Œæˆå¾Œ

**å…©ç¨®çµç®—æ‰£é™¤**:

#### A. ä¸€èˆ¬çµç®—æ‰£é¡åº¦ (OrderController.cs ç¬¬ 1620-1631 è¡Œ)
```csharp
string QuotaResult = cls_member.Up_memQuotaAndAddHistory(new Obj_AddQuotaHistory()
{
    user_account = obj_grant_result.user_account,
    QuotaChange = Convert.ToInt32(deduct),  // æ‰£é™¤é‡‘é¡
    ChangeType = QuotaChangeEnum.DeductQuotaSettlement,  // çµç®—æ‰£é™¤
    ChangeReason = "çµç®—æ‰£é™¤é¡åº¦",
    Logistic_service = "00",
    LogisticNumber = "",
    paymentno = "",
    sno = "0",
    ChangDate = DateTime.Now.ToString("yyyyMMdd")
});
```

#### B. å‰æœŸè² æ•¸çµç®—æ‰£é¡åº¦ (OrderController.cs ç¬¬ 1636-1653 è¡Œ)
```csharp
// å‰æœŸçš„æœªçµç´€éŒ„
foreach (Obj_Grant_result obj_grant_result in Obj_Grant_HistoryresultList)
{
    // æ ¹æ“šå¯¦æ’¥é‡‘é¡å»å€’æ‰£å•†å®¶é¡åº¦
    decimal deduct = Convert.ToDecimal(obj_grant_result.GrantTotalAmount);
    cls_order.Up_Grant_History_txtName(obj_grant_result, grantTxtResult.AchTxtName);

    string QuotaResult = cls_member.Up_memQuotaAndAddHistory(new Obj_AddQuotaHistory()
    {
        user_account = obj_grant_result.user_account,
        QuotaChange = Convert.ToInt32(deduct),  // è² æ•¸æ‰£é™¤
        ChangeType = QuotaChangeEnum.DeductNegativeQuotaSettlement,  // è² æ•¸çµç®—æ‰£é™¤
        ChangeReason = "çµç®—æ‰£é™¤è² æ•¸é¡åº¦",
        Logistic_service = "00",
        LogisticNumber = "",
        paymentno = "",
        sno = "0",
        ChangDate = DateTime.Now.ToString("yyyyMMdd")
    });
}
```

**é—œéµé‚è¼¯**:
1. **ä¸€èˆ¬çµç®—**: å¾å•†å®¶é¡åº¦æ‰£é™¤ `å¯¦éš›æ’¥æ¬¾é‡‘é¡`
2. **å‰æœŸè² æ•¸çµç®—**: å¦‚æœå•†å®¶æœ‰å‰æœŸæ¬ è²»è¢«æœ¬æ¬¡æ‰£é™¤,ä¹Ÿè¦å¾é¡åº¦æ‰£é™¤è©²æ¬ è²»é‡‘é¡

---

## ğŸ¯ èª¤æ’¥é€€è²¨è¨‚å–®çš„è£œæ•‘æ–¹æ¡ˆ

### å•é¡Œåˆ†æ

å¾ä½ çš„ SQL æŸ¥è©¢:
```sql
select *,TotalAmount-Service_fee-m as d from(
    select user_account,
           sum(TotalAmount) TotalAmount,
           sum(Service_fee) Service_fee,
           (
               select sum(TotalAmount)
               from Order_Info
               where LogisticNumber in (
                   select LogisticNumber
                   from Order_Accounting
                   where GrantdaisouDate > '2025/10/15 00:00:00'
               )
               and Detail_Status_Description != 'è²·å®¶å·²å–ä»¶'
               and Detail_Status_Description != 'æ¶ˆè²»è€…æˆåŠŸå–ä»¶'
               and user_account=Order_Accounting.user_account
           ) as m
    from Order_Accounting
    where GrantdaisouDate > '2025/10/15 00:00:00'
    group by user_account
) a
order by d
```

**è¨ˆç®—é‚è¼¯**:
- `TotalAmount` = è©²å•†å®¶æ‰€æœ‰æ’¥æ¬¾çš„ä»£æ”¶æ¬¾ç¸½é¡
- `Service_fee` = è©²å•†å®¶æ‰€æœ‰æ’¥æ¬¾çš„æœå‹™è²»ç¸½é¡
- `m` = è©²å•†å®¶ç•°å¸¸è¨‚å–®(é€€è²¨/å–æ¶ˆ)çš„ä»£æ”¶æ¬¾ç¸½é¡
- `d` = `TotalAmount - Service_fee - m` = **å•†å®¶å¯¦éš›æ‡‰æ”¶é‡‘é¡ - ç•°å¸¸ä»£æ”¶æ¬¾**

### è£œæ•‘æ–¹æ¡ˆè¨­è¨ˆ

#### æ–¹æ¡ˆé¸æ“‡åˆ¤æ–·

æ ¹æ“š `d` å€¼æ±ºå®š:

| d å€¼ | èªªæ˜ | è™•ç†æ–¹å¼ |
|------|------|---------|
| **d > 0** | æ‰£é™¤ç•°å¸¸å¾Œ,å•†å®¶é‚„æœ‰æ­£æ•¸å¯æ’¥æ¬¾ | ä¸å¯«æ¬ è²»,ä¸‹æ¬¡æ’¥æ¬¾ç›´æ¥æ‰£é™¤ |
| **d = 0** | æ‰£é™¤ç•°å¸¸å¾Œ,å‰›å¥½æ­¸é›¶ | ä¸å¯«æ¬ è²»,ä¹Ÿä¸æ’¥æ¬¾ |
| **d < 0** | æ‰£é™¤ç•°å¸¸å¾Œ,å•†å®¶è®Šæˆæ¬ è²» | **å¯«å…¥ Grant_History** |

---

## ğŸ“ è£œæ•‘æ–¹æ¡ˆ SQL

### æ­¥é©Ÿ 1: æŸ¥è©¢éœ€è¦è™•ç†çš„å•†å®¶

```sql
-- ========================================
-- æŸ¥è©¢èª¤æ’¥å•†å®¶çš„æ‡‰è™•ç†é‡‘é¡
-- ========================================
WITH MerchantSummary AS (
    SELECT
        oa.user_account,
        oa.sonid,
        bm.mem_Branchwebname AS MerchantName,
        bm.bank_code,
        bm.bank_branch_code,
        bm.bank_account,
        bm.account_name,
        SUM(oa.TotalAmount) AS TotalAmount,  -- æ‰€æœ‰æ’¥æ¬¾çš„ä»£æ”¶æ¬¾ç¸½é¡
        SUM(oa.Service_fee) AS Service_fee,  -- æœå‹™è²»ç¸½é¡
        SUM(oa.cost) AS cost,  -- æˆæœ¬ç¸½é¡
        -- è¨ˆç®—ç•°å¸¸è¨‚å–®çš„ä»£æ”¶æ¬¾ç¸½é¡
        (
            SELECT ISNULL(SUM(oi2.TotalAmount), 0)
            FROM Order_Accounting oa2
            INNER JOIN Order_Info oi2
                ON oa2.LogisticNumber = oi2.LogisticNumber
                AND oa2.sno = oi2.sno
            WHERE oa2.GrantdaisouDate > '2025-10-15 00:00:00'
                AND oa2.user_account = oa.user_account
                AND oa2.sonid = oa.sonid
                AND oi2.Detail_Status_Description NOT IN ('è²·å®¶å·²å–ä»¶', 'æ¶ˆè²»è€…æˆåŠŸå–ä»¶')
        ) AS AbnormalAmount
    FROM Order_Accounting oa
    INNER JOIN Branch_Member bm
        ON oa.user_account = bm.user_account
        AND oa.sonid = bm.sonid
    WHERE oa.GrantdaisouDate > '2025-10-15 00:00:00'
        AND oa.DeliverMode = '01'
    GROUP BY
        oa.user_account,
        oa.sonid,
        bm.mem_Branchwebname,
        bm.bank_code,
        bm.bank_branch_code,
        bm.bank_account,
        bm.account_name
)
SELECT
    user_account,
    sonid,
    MerchantName,
    bank_code,
    bank_branch_code,
    bank_account,
    account_name,
    TotalAmount,  -- ä»£æ”¶æ¬¾ç¸½é¡
    Service_fee,  -- æœå‹™è²»ç¸½é¡
    cost,  -- æˆæœ¬ç¸½é¡
    AbnormalAmount,  -- ç•°å¸¸ä»£æ”¶æ¬¾
    (TotalAmount - Service_fee) AS NetAmount,  -- å•†å®¶æ‡‰æ”¶æ·¨é¡
    (TotalAmount - Service_fee - AbnormalAmount) AS FinalAmount,  -- æ‰£é™¤ç•°å¸¸å¾Œé‡‘é¡
    -- åˆ¤æ–·è™•ç†æ–¹å¼
    CASE
        WHEN (TotalAmount - Service_fee - AbnormalAmount) > 0 THEN 'æ­£æ•¸-ä¸‹æ¬¡æ‰£é™¤'
        WHEN (TotalAmount - Service_fee - AbnormalAmount) = 0 THEN 'æ­¸é›¶-ä¸è™•ç†'
        WHEN (TotalAmount - Service_fee - AbnormalAmount) < 0 THEN 'è² æ•¸-å¯«æ¬ è²»'
    END AS è™•ç†æ–¹å¼,
    -- å¦‚æœæ˜¯è² æ•¸,é€™å°±æ˜¯æ¬ è²»é‡‘é¡
    CASE
        WHEN (TotalAmount - Service_fee - AbnormalAmount) < 0
        THEN (TotalAmount - Service_fee - AbnormalAmount)
        ELSE 0
    END AS æ¬ è²»é‡‘é¡
FROM MerchantSummary
ORDER BY FinalAmount ASC;
```

### æ­¥é©Ÿ 2: å»ºç«‹ Grant_History æ¬ è²»è¨˜éŒ„ (åƒ…é‡å° d < 0 çš„å•†å®¶)

```sql
-- ========================================
-- å¯«å…¥ Grant_History æ¬ è²»è¨˜éŒ„
-- ========================================
WITH MerchantDebt AS (
    SELECT
        oa.user_account,
        oa.sonid,
        bm.mem_Branchwebname AS MerchantName,
        bm.bank_code,
        bm.bank_branch_code,
        bm.bank_account,
        bm.account_name,
        bm.bankname,
        SUM(oa.TotalAmount) AS TotalAmount,
        SUM(oa.Service_fee) AS Service_fee,
        (
            SELECT ISNULL(SUM(oi2.TotalAmount), 0)
            FROM Order_Accounting oa2
            INNER JOIN Order_Info oi2
                ON oa2.LogisticNumber = oi2.LogisticNumber
                AND oa2.sno = oi2.sno
            WHERE oa2.GrantdaisouDate > '2025-10-15 00:00:00'
                AND oa2.user_account = oa.user_account
                AND oa2.sonid = oa.sonid
                AND oi2.Detail_Status_Description NOT IN ('è²·å®¶å·²å–ä»¶', 'æ¶ˆè²»è€…æˆåŠŸå–ä»¶')
        ) AS AbnormalAmount,
        GETDATE() AS GrantDate
    FROM Order_Accounting oa
    INNER JOIN Branch_Member bm
        ON oa.user_account = bm.user_account
        AND oa.sonid = bm.sonid
    WHERE oa.GrantdaisouDate > '2025-10-15 00:00:00'
        AND oa.DeliverMode = '01'
    GROUP BY
        oa.user_account,
        oa.sonid,
        bm.mem_Branchwebname,
        bm.bank_code,
        bm.bank_branch_code,
        bm.bank_account,
        bm.account_name,
        bm.bankname
    HAVING (SUM(oa.TotalAmount) - SUM(oa.Service_fee) -
            (
                SELECT ISNULL(SUM(oi2.TotalAmount), 0)
                FROM Order_Accounting oa2
                INNER JOIN Order_Info oi2
                    ON oa2.LogisticNumber = oi2.LogisticNumber
                    AND oa2.sno = oi2.sno
                WHERE oa2.GrantdaisouDate > '2025-10-15 00:00:00'
                    AND oa2.user_account = oa.user_account
                    AND oa2.sonid = oa.sonid
                    AND oi2.Detail_Status_Description NOT IN ('è²·å®¶å·²å–ä»¶', 'æ¶ˆè²»è€…æˆåŠŸå–ä»¶')
            )) < 0  -- åªè™•ç†è² æ•¸(æ¬ è²»)çš„å•†å®¶
)
INSERT INTO Grant_History (
    bank_account,
    bank_code,
    bank_branch_code,
    user_account,
    account_name,
    bankname,
    GrantTotalAmount,  -- è² æ•¸
    Excel_Name,
    Grant_txtName,
    Grantdate,
    TotalServicefee,
    BulkGrantTotalAmount,
    SettledAmount,
    grant_type
)
SELECT
    bank_account,
    bank_code,
    bank_branch_code,
    user_account,
    account_name,
    bankname,
    -- GrantTotalAmount = è² æ•¸æ¬ è²»é‡‘é¡
    (TotalAmount - Service_fee - AbnormalAmount) AS GrantTotalAmount,
    'èª¤æ’¥é€€è²¨è£œæ•‘_' + CONVERT(VARCHAR(10), GETDATE(), 112) AS Excel_Name,  -- ä¾‹: èª¤æ’¥é€€è²¨è£œæ•‘_20251017
    '' AS Grant_txtName,  -- ç©ºå€¼,å› ç‚ºæ²’æœ‰å¯¦éš›æ’¥æ¬¾æª”
    CAST(GETDATE() AS DATE) AS Grantdate,
    Service_fee AS TotalServicefee,
    0 AS BulkGrantTotalAmount,
    0 AS SettledAmount,
    1 AS grant_type  -- 1 = C2C
FROM MerchantDebt;

-- æŸ¥çœ‹æ’å…¥çµæœ
SELECT @@ROWCOUNT AS 'å¯«å…¥æ¬ è²»è¨˜éŒ„ç­†æ•¸';
```

### æ­¥é©Ÿ 3: å»ºç«‹è£œå„Ÿè¨˜éŒ„ (é‡å° d >= 0 çš„å•†å®¶,ä¸‹æ¬¡æ’¥æ¬¾æ‰£é™¤)

```sql
-- ========================================
-- å»ºç«‹è£œå„Ÿè¨˜éŒ„ (d >= 0 çš„å•†å®¶,ä¸å¯«æ¬ è²»,æ”¹ç”¨è£œå„Ÿæ©Ÿåˆ¶)
-- ========================================
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'Grant_Compensation')
BEGIN
    -- è«‹åƒè€ƒä¹‹å‰çš„ã€Œé€€è²¨è¨‚å–®èª¤æ’¥ä»£æ”¶æ¬¾_å¯¦éš›åŸ·è¡Œæ–¹æ¡ˆ.mdã€ä¸­çš„å»ºè¡¨SQL
    PRINT 'è«‹å…ˆå»ºç«‹ Grant_Compensation è¡¨';
END
ELSE
BEGIN
    WITH MerchantComp AS (
        SELECT
            oa.user_account,
            oa.sonid,
            bm.bank_code,
            bm.bank_branch_code,
            bm.bank_account,
            bm.account_name,
            SUM(oa.TotalAmount) AS TotalAmount,
            SUM(oa.Service_fee) AS Service_fee,
            (
                SELECT ISNULL(SUM(oi2.TotalAmount), 0)
                FROM Order_Accounting oa2
                INNER JOIN Order_Info oi2
                    ON oa2.LogisticNumber = oi2.LogisticNumber
                    AND oa2.sno = oi2.sno
                WHERE oa2.GrantdaisouDate > '2025-10-15 00:00:00'
                    AND oa2.user_account = oa.user_account
                    AND oa2.sonid = oa.sonid
                    AND oi2.Detail_Status_Description NOT IN ('è²·å®¶å·²å–ä»¶', 'æ¶ˆè²»è€…æˆåŠŸå–ä»¶')
            ) AS AbnormalAmount
        FROM Order_Accounting oa
        INNER JOIN Branch_Member bm
            ON oa.user_account = bm.user_account
            AND oa.sonid = bm.sonid
        WHERE oa.GrantdaisouDate > '2025-10-15 00:00:00'
            AND oa.DeliverMode = '01'
        GROUP BY
            oa.user_account,
            oa.sonid,
            bm.bank_code,
            bm.bank_branch_code,
            bm.bank_account,
            bm.account_name
        HAVING (SUM(oa.TotalAmount) - SUM(oa.Service_fee) -
                (
                    SELECT ISNULL(SUM(oi2.TotalAmount), 0)
                    FROM Order_Accounting oa2
                    INNER JOIN Order_Info oi2
                        ON oa2.LogisticNumber = oi2.LogisticNumber
                        AND oa2.sno = oi2.sno
                    WHERE oa2.GrantdaisouDate > '2025-10-15 00:00:00'
                        AND oa2.user_account = oa.user_account
                        AND oa2.sonid = oa.sonid
                        AND oi2.Detail_Status_Description NOT IN ('è²·å®¶å·²å–ä»¶', 'æ¶ˆè²»è€…æˆåŠŸå–ä»¶')
                )) >= 0  -- åªè™•ç† >= 0 çš„å•†å®¶
    )
    -- æ’å…¥ç•°å¸¸è¨‚å–®çš„æ˜ç´°åˆ° Grant_Compensation
    INSERT INTO Grant_Compensation (
        LogisticNumber,
        sno,
        user_account,
        sonid,
        Logistic_service,
        OrderNo,
        OriginalGrantDate,
        CompensationType,
        AbnormalStatus,
        CompensationAmount,  -- è² æ•¸
        TotalAmount,
        Service_fee,
        cost,
        Status,
        Remark,
        CreateDate
    )
    SELECT
        oa.LogisticNumber,
        oa.sno,
        oa.user_account,
        oa.sonid,
        oa.Logistic_service,
        oa.OrderNo,
        oa.GrantdaisouDate AS OriginalGrantDate,
        -- åˆ¤æ–·è£œå„Ÿé¡å‹
        CASE
            WHEN oi.Detail_Status_Description LIKE '%é€€è²¨%' THEN 'é€€è²¨èª¤æ’¥'
            WHEN oi.Detail_Status_Description LIKE '%å–æ¶ˆ%' THEN 'å–æ¶ˆèª¤æ’¥'
            WHEN oi.Detail_Status_Description LIKE '%é€¾æœŸ%' THEN 'é€¾æœŸèª¤æ’¥'
            WHEN oi.Detail_Status_Description LIKE '%æ‹’æ”¶%' THEN 'æ‹’æ”¶èª¤æ’¥'
            ELSE 'å…¶ä»–ç•°å¸¸èª¤æ’¥'
        END AS CompensationType,
        oi.Detail_Status_Description AS AbnormalStatus,
        -- è£œå„Ÿé‡‘é¡ = -(ä»£æ”¶æ¬¾ - æœå‹™è²»),è² æ•¸è¡¨ç¤ºè¦æ‰£å›
        -(oa.TotalAmount - ISNULL(oa.Service_fee, 0)) AS CompensationAmount,
        oa.TotalAmount,
        oa.Service_fee,
        oa.cost,
        'Pending' AS Status,
        'èª¤æ’¥é€€è²¨è¨‚å–®è£œæ•‘-ä¸‹æ¬¡æ’¥æ¬¾æ‰£é™¤' AS Remark,
        GETDATE()
    FROM Order_Accounting oa
    INNER JOIN Order_Info oi
        ON oa.LogisticNumber = oi.LogisticNumber
        AND oa.sno = oi.sno
    WHERE oa.GrantdaisouDate > '2025-10-15 00:00:00'
        AND oa.DeliverMode = '01'
        AND oi.Detail_Status_Description NOT IN ('è²·å®¶å·²å–ä»¶', 'æ¶ˆè²»è€…æˆåŠŸå–ä»¶')
        -- åªè™•ç†å•†å®¶çµæœ >= 0 çš„è¨‚å–®
        AND EXISTS (
            SELECT 1 FROM MerchantComp mc
            WHERE mc.user_account = oa.user_account
                AND mc.sonid = oa.sonid
        )
        -- é¿å…é‡è¤‡æ’å…¥
        AND NOT EXISTS (
            SELECT 1 FROM Grant_Compensation gc
            WHERE gc.LogisticNumber = oa.LogisticNumber
                AND gc.sno = oa.sno
                AND gc.OriginalGrantDate = oa.GrantdaisouDate
        );

    -- æŸ¥çœ‹æ’å…¥çµæœ
    SELECT @@ROWCOUNT AS 'æ’å…¥è£œå„Ÿè¨˜éŒ„ç­†æ•¸';
END
```

---

## ğŸ“Š é©—è­‰èˆ‡è¿½è¹¤

### æŸ¥è©¢æ¬ è²»å¯«å…¥çµæœ

```sql
-- ========================================
-- æŸ¥è©¢å¯«å…¥ Grant_History çš„æ¬ è²»è¨˜éŒ„
-- ========================================
SELECT
    gh.user_account,
    bm.mem_Branchwebname AS MerchantName,
    gh.bank_code,
    gh.bank_account,
    gh.account_name,
    gh.GrantTotalAmount AS æ¬ è²»é‡‘é¡,  -- è² æ•¸
    gh.TotalServicefee AS æœå‹™è²»,
    gh.Excel_Name,
    gh.Grantdate AS æ¬ è²»æ—¥,
    gh.Grant_txtName AS æ’¥æ¬¾æª”å,
    CASE
        WHEN gh.Grant_txtName IS NULL OR gh.Grant_txtName = '' THEN 'æœªçµç®—'
        ELSE 'å·²çµç®—'
    END AS çµç®—ç‹€æ…‹
FROM Grant_History gh
INNER JOIN Branch_Member bm
    ON gh.user_account = bm.user_account
WHERE gh.Excel_Name LIKE 'èª¤æ’¥é€€è²¨è£œæ•‘%'
ORDER BY gh.GrantTotalAmount ASC;
```

### æŸ¥è©¢è£œå„Ÿè¨˜éŒ„çµæœ

```sql
-- ========================================
-- æŸ¥è©¢è£œå„Ÿè¨˜éŒ„(d >= 0 çš„å•†å®¶)
-- ========================================
SELECT
    gc.user_account,
    gc.sonid,
    bm.mem_Branchwebname AS MerchantName,
    gc.CompensationType AS è£œå„Ÿé¡å‹,
    COUNT(*) AS è¨‚å–®æ•¸,
    SUM(gc.CompensationAmount) AS è£œå„Ÿé‡‘é¡,  -- è² æ•¸
    gc.Status AS ç‹€æ…‹
FROM Grant_Compensation gc
INNER JOIN Branch_Member bm
    ON gc.user_account = bm.user_account
    AND gc.sonid = bm.sonid
WHERE gc.Remark LIKE '%èª¤æ’¥é€€è²¨è¨‚å–®è£œæ•‘%'
GROUP BY
    gc.user_account,
    gc.sonid,
    bm.mem_Branchwebname,
    gc.CompensationType,
    gc.Status
ORDER BY è£œå„Ÿé‡‘é¡ ASC;
```

### ç¸½è¦½å ±è¡¨

```sql
-- ========================================
-- ç¸½è¦½:èª¤æ’¥è£œæ•‘è™•ç†çµ±è¨ˆ
-- ========================================
WITH AllMerchants AS (
    -- æ‰€æœ‰å—å½±éŸ¿çš„å•†å®¶
    SELECT DISTINCT
        oa.user_account,
        oa.sonid,
        bm.mem_Branchwebname AS MerchantName
    FROM Order_Accounting oa
    INNER JOIN Branch_Member bm
        ON oa.user_account = bm.user_account
        AND oa.sonid = bm.sonid
    WHERE oa.GrantdaisouDate > '2025-10-15 00:00:00'
        AND oa.DeliverMode = '01'
),
DebtMerchants AS (
    -- å¯«å…¥æ¬ è²»çš„å•†å®¶
    SELECT
        user_account,
        SUM(GrantTotalAmount) AS DebtAmount
    FROM Grant_History
    WHERE Excel_Name LIKE 'èª¤æ’¥é€€è²¨è£œæ•‘%'
    GROUP BY user_account
),
CompMerchants AS (
    -- å¯«å…¥è£œå„Ÿçš„å•†å®¶
    SELECT
        user_account,
        sonid,
        SUM(CompensationAmount) AS CompAmount
    FROM Grant_Compensation
    WHERE Remark LIKE '%èª¤æ’¥é€€è²¨è¨‚å–®è£œæ•‘%'
    GROUP BY user_account, sonid
)
SELECT
    am.user_account,
    am.MerchantName,
    CASE
        WHEN dm.user_account IS NOT NULL THEN 'å¯«æ¬ è²»'
        WHEN cm.user_account IS NOT NULL THEN 'è£œå„Ÿæ‰£é™¤'
        ELSE 'æœªè™•ç†'
    END AS è™•ç†æ–¹å¼,
    ISNULL(dm.DebtAmount, 0) AS æ¬ è²»é‡‘é¡,
    ISNULL(cm.CompAmount, 0) AS è£œå„Ÿé‡‘é¡
FROM AllMerchants am
LEFT JOIN DebtMerchants dm
    ON am.user_account = dm.user_account
LEFT JOIN CompMerchants cm
    ON am.user_account = cm.user_account
    AND am.sonid = cm.sonid
ORDER BY am.user_account;
```

---

## ğŸ”„ çµç®—æ‰£é¡åº¦è™•ç†

### æ˜¯å¦éœ€è¦æ‰‹å‹•æ‰£é¡åº¦?

**ç­”**: **ä¸éœ€è¦**

**åŸå› **:
1. **å¯«æ¬ è²»çš„å•†å®¶** (d < 0):
   - æ¬ è²»è¨˜éŒ„å¯«å…¥ `Grant_History`
   - ä¸‹æ¬¡æ’¥æ¬¾æ™‚,ç³»çµ±æœƒè‡ªå‹•å¾æ’¥æ¬¾æ‰£é™¤æ¬ è²» (OrderController.cs ç¬¬ 1388-1414 è¡Œ)
   - æ‰£é™¤æ™‚æœƒè‡ªå‹•åŸ·è¡Œ `QuotaChangeEnum.DeductNegativeQuotaSettlement` (ç¬¬ 1646 è¡Œ)
   - **ç³»çµ±æœƒè‡ªå‹•è™•ç†é¡åº¦æ‰£é™¤**

2. **è£œå„Ÿæ‰£é™¤çš„å•†å®¶** (d >= 0):
   - è£œå„Ÿè¨˜éŒ„å¯«å…¥ `Grant_Compensation`
   - ä¸‹æ¬¡æ’¥æ¬¾æ™‚å¾æ’¥æ¬¾æ‰£é™¤è£œå„Ÿé‡‘é¡
   - æ‰£é™¤æ™‚æœƒåŸ·è¡Œ `QuotaChangeEnum.DeductQuotaSettlement` (ç¬¬ 1624 è¡Œ)
   - **ç³»çµ±ä¹Ÿæœƒè‡ªå‹•è™•ç†é¡åº¦æ‰£é™¤**

### ç‰¹æ®Šæƒ…æ³:å¦‚æœéœ€è¦ç«‹å³æ‰£é¡åº¦

å¦‚æœå•†å®¶çŸ­æœŸå…§ä¸æœƒæœ‰æ’¥æ¬¾,ä½†å…¬å¸å¸Œæœ›ç«‹å³æ‰£é™¤é¡åº¦,å¯ä»¥åŸ·è¡Œ:

```sql
-- ========================================
-- æ‰‹å‹•æ‰£é™¤å•†å®¶é¡åº¦ (è¬¹æ…ä½¿ç”¨!)
-- ========================================
-- åƒ…ä¾›åƒè€ƒ,å¯¦éš›åŸ·è¡Œè«‹ç”±æ¥­å‹™å’Œè²¡å‹™ç¢ºèª

-- æŸ¥è©¢éœ€è¦æ‰£é¡åº¦çš„å•†å®¶
SELECT
    gh.user_account,
    bm.mem_Branchwebname AS MerchantName,
    gh.GrantTotalAmount AS æ¬ è²»é‡‘é¡,
    bm.mem_Qutoa AS ç›®å‰é¡åº¦,
    bm.mem_Qutoa + gh.GrantTotalAmount AS æ‰£é™¤å¾Œé¡åº¦  -- æ¬ è²»æ˜¯è² æ•¸,æ‰€ä»¥æ˜¯ç›¸æ¸›
FROM Grant_History gh
INNER JOIN Branch_Member bm
    ON gh.user_account = bm.user_account
WHERE gh.Excel_Name LIKE 'èª¤æ’¥é€€è²¨è£œæ•‘%'
    AND (gh.Grant_txtName IS NULL OR gh.Grant_txtName = '')  -- æœªçµç®—çš„
ORDER BY gh.GrantTotalAmount ASC;

-- åŸ·è¡Œæ‰£é¡åº¦ (éœ€è¦å‘¼å« Up_memQuotaAndAddHistory æ–¹æ³•)
-- å»ºè­°é€éç¨‹å¼åŸ·è¡Œ,ä¸è¦ç›´æ¥ UPDATE Branch_Member
```

---

## âœ… åŸ·è¡Œæª¢æŸ¥æ¸…å–®

### åŸ·è¡Œå‰

- [ ] å‚™ä»½ `Grant_History`, `Grant_Compensation`, `Branch_Member` è¡¨
- [ ] åœ¨æ¸¬è©¦ç’°å¢ƒåŸ·è¡Œæ‰€æœ‰ SQL,é©—è­‰é‚è¼¯æ­£ç¢º
- [ ] ç¢ºèªå—å½±éŸ¿çš„14å€‹å•†å®¶å¸³è™Ÿç„¡èª¤
- [ ] äººå·¥æ ¸å°ã€Œæ¬ è²»å•†å®¶ã€å’Œã€Œè£œå„Ÿå•†å®¶ã€çš„é‡‘é¡

### åŸ·è¡Œæ­¥é©Ÿ

1. [ ] åŸ·è¡Œæ­¥é©Ÿ1æŸ¥è©¢,åŒ¯å‡ºå•†å®¶è™•ç†æ¸…å–®
2. [ ] åŸ·è¡Œæ­¥é©Ÿ2,å¯«å…¥ Grant_History æ¬ è²»è¨˜éŒ„ (d < 0 çš„å•†å®¶)
3. [ ] åŸ·è¡Œæ­¥é©Ÿ3,å¯«å…¥ Grant_Compensation è£œå„Ÿè¨˜éŒ„ (d >= 0 çš„å•†å®¶)
4. [ ] åŸ·è¡Œé©—è­‰æŸ¥è©¢,ç¢ºèªå¯«å…¥æ­£ç¢º
5. [ ] ç”¢ç”Ÿå ±è¡¨çµ¦è²¡å‹™å’Œæ¥­å‹™å–®ä½ç¢ºèª

### åŸ·è¡Œå¾Œ

- [ ] ç›£æ§ä¸‹æ¬¡æ’¥æ¬¾æ™‚,æ¬ è²»å’Œè£œå„Ÿæ˜¯å¦æ­£ç¢ºæ‰£é™¤
- [ ] æª¢æŸ¥é¡åº¦è®Šå‹•è¨˜éŒ„
- [ ] æ›´æ–°æ“ä½œæ–‡ä»¶å’Œ SOP

---

## ğŸ“Œ é‡è¦æé†’

1. **æ¬ è²»vsè£œå„Ÿçš„é¸æ“‡**:
   - `d < 0`: å¯« `Grant_History` æ¬ è²»
   - `d >= 0`: å¯« `Grant_Compensation` è£œå„Ÿ
   - å…©è€…é‚è¼¯ä¸åŒ,ä¸å¯æ··ç”¨

2. **é¡åº¦æ‰£é™¤æ™‚æ©Ÿ**:
   - å¯«æ¬ è²»: ä¸‹æ¬¡æ’¥æ¬¾æ™‚è‡ªå‹•æ‰£
   - å¯«è£œå„Ÿ: ä¸‹æ¬¡æ’¥æ¬¾æ™‚è‡ªå‹•æ‰£
   - **éƒ½æ˜¯è‡ªå‹•è™•ç†,ä¸éœ€è¦æ‰‹å‹•æ‰£é¡åº¦**

3. **æ’¥æ¬¾æª”å (Grant_txtName)**:
   - æ¬ è²»è¨˜éŒ„: åˆå§‹ç‚ºç©º
   - ä¸‹æ¬¡æ’¥æ¬¾æ‰£é™¤æ™‚,æœƒæ›´æ–°ç‚ºå¯¦éš›çš„æ’¥æ¬¾æª”å
   - æ›´æ–°å¾Œè¡¨ç¤ºã€Œå·²çµç®—ã€

4. **é¿å…é‡è¤‡å¯«å…¥**:
   - SQL ä¸­å·²åŠ å…¥ `NOT EXISTS` æª¢æŸ¥
   - åŸ·è¡Œå‰å…ˆæŸ¥è©¢æ˜¯å¦å·²å­˜åœ¨è¨˜éŒ„

5. **èˆ‡ç¾æœ‰ç³»çµ±æ•´åˆ**:
   - æ­¤æ–¹æ¡ˆå®Œå…¨ç›¸å®¹ç¾æœ‰çš„æ’¥æ¬¾æµç¨‹
   - ä¸éœ€è¦ä¿®æ”¹ OrderController çš„æ’¥æ¬¾é‚è¼¯
   - åªéœ€è¦æ­£ç¢ºå¯«å…¥ `Grant_History` æˆ– `Grant_Compensation`
