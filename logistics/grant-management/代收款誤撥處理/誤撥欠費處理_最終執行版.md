# 誤撥退貨訂單 - 欠費處理最終執行版

## 📋 執行說明

此為最終執行版,包含:
1. ✅ 查詢需要寫欠費的商家 (d < 0)
2. ✅ INSERT 欠費記錄到 Grant_History
3. ✅ 驗證寫入結果

**執行時機**: 會計已手動不撥款給這14個商家後

---

## 步驟 1:查詢需要寫欠費的商家 (d < 0)

```sql
-- ========================================
-- 查詢需要寫欠費的商家
-- ========================================
WITH MerchantSummary AS (
    SELECT
        oa.user_account,
        oa.sonid,
        bm.mem_Branchwebname AS MerchantName,
        bm.bank_code,
        bm.bank_branch_code,
        bm.bank_account,
        bm.account_name,
        bm.bankname,
        -- 該商家所有撥款訂單
        SUM(oa.TotalAmount) AS TotalAmount,
        SUM(oa.Service_fee) AS Service_fee,
        SUM(oa.cost) AS cost,
        COUNT(*) AS TotalOrders,
        -- 該商家異常訂單的代收款
        (
            SELECT ISNULL(SUM(oa2.TotalAmount), 0)
            FROM Order_Accounting oa2
            INNER JOIN Order_Info oi2
                ON oa2.LogisticNumber = oi2.LogisticNumber
                AND oa2.sno = oi2.sno
            WHERE oa2.GrantdaisouDate > '2025-10-15 00:00:00'
                AND oa2.user_account = oa.user_account
                AND oa2.sonid = oa.sonid
                AND oi2.Detail_Status_Description NOT IN ('買家已取件', '消費者成功取件')
        ) AS AbnormalAmount,
        -- 異常訂單筆數
        (
            SELECT COUNT(*)
            FROM Order_Accounting oa2
            INNER JOIN Order_Info oi2
                ON oa2.LogisticNumber = oi2.LogisticNumber
                AND oa2.sno = oi2.sno
            WHERE oa2.GrantdaisouDate > '2025-10-15 00:00:00'
                AND oa2.user_account = oa.user_account
                AND oa2.sonid = oa.sonid
                AND oi2.Detail_Status_Description NOT IN ('買家已取件', '消費者成功取件')
        ) AS AbnormalOrders
    FROM Order_Accounting oa
    INNER JOIN Branch_Member bm
        ON oa.user_account = bm.user_account
        AND oa.sonid = bm.sonid
    WHERE oa.GrantdaisouDate > '2025-10-15 00:00:00'
        AND oa.DeliverMode = '01'
        AND oa.user_account IN (
            '92653668', '96771271', '54895238', '90438307',
            '98648853', '85238336', '90081094', '27545589',
            '82379115', '83614969', '93192566', '22607683',
            '24584898', '41327634'
        )
    GROUP BY
        oa.user_account,
        oa.sonid,
        bm.mem_Branchwebname,
        bm.bank_code,
        bm.bank_branch_code,
        bm.bank_account,
        bm.account_name,
        bm.bankname
)
SELECT
    user_account,
    sonid,
    MerchantName,
    bank_code,
    bank_branch_code,
    bank_account,
    account_name,
    bankname,
    TotalAmount AS 代收款總額,
    Service_fee AS 服務費總額,
    cost AS 成本總額,
    TotalOrders AS 總訂單數,
    AbnormalAmount AS 異常代收款,
    AbnormalOrders AS 異常訂單數,
    (TotalAmount - Service_fee) AS 商家應收淨額,
    (TotalAmount - Service_fee - AbnormalAmount) AS d值_欠費金額,
    CASE
        WHEN (TotalAmount - Service_fee - AbnormalAmount) > 0 THEN '正數-不處理(會計已不撥)'
        WHEN (TotalAmount - Service_fee - AbnormalAmount) = 0 THEN '歸零-不處理'
        WHEN (TotalAmount - Service_fee - AbnormalAmount) < 0 THEN '★負數-需寫欠費★'
    END AS 處理方式
FROM MerchantSummary
ORDER BY d值_欠費金額 ASC;
```

**執行結果說明**:
- 檢查「處理方式」欄位
- 只有顯示「★負數-需寫欠費★」的商家需要執行 INSERT
- 「d值_欠費金額」就是要寫入 Grant_History 的 GrantTotalAmount (負數)

---

## 步驟 2:寫入欠費記錄到 Grant_History

### 2-1. 先執行檢查 (避免重複寫入)

```sql
-- ========================================
-- 檢查是否已經寫入過
-- ========================================
SELECT
    user_account,
    bank_account,
    account_name,
    GrantTotalAmount AS 欠費金額,
    Excel_Name,
    Grantdate,
    Grant_txtName
FROM Grant_History
WHERE Excel_Name LIKE '誤撥退貨補救_%'
    AND user_account IN (
        '92653668', '96771271', '54895238', '90438307',
        '98648853', '85238336', '90081094', '27545589',
        '82379115', '83614969', '93192566', '22607683',
        '24584898', '41327634'
    )
ORDER BY user_account;
```

**如果有資料**: 表示已經寫入過,請確認是否需要重複寫入
**如果沒資料**: 可以執行 INSERT

### 2-2. 執行 INSERT 寫入欠費

```sql
-- ========================================
-- INSERT 欠費記錄到 Grant_History
-- ========================================
WITH MerchantDebt AS (
    SELECT
        oa.user_account,
        oa.sonid,
        bm.bank_code,
        bm.bank_branch_code,
        bm.bank_account,
        bm.account_name,
        bm.bankname,
        SUM(oa.TotalAmount) AS TotalAmount,
        SUM(oa.Service_fee) AS Service_fee,
        (
            SELECT ISNULL(SUM(oa2.TotalAmount), 0)
            FROM Order_Accounting oa2
            INNER JOIN Order_Info oi2
                ON oa2.LogisticNumber = oi2.LogisticNumber
                AND oa2.sno = oi2.sno
            WHERE oa2.GrantdaisouDate > '2025-10-15 00:00:00'
                AND oa2.user_account = oa.user_account
                AND oa2.sonid = oa.sonid
                AND oi2.Detail_Status_Description NOT IN ('買家已取件', '消費者成功取件')
        ) AS AbnormalAmount
    FROM Order_Accounting oa
    INNER JOIN Branch_Member bm
        ON oa.user_account = bm.user_account
        AND oa.sonid = bm.sonid
    WHERE oa.GrantdaisouDate > '2025-10-15 00:00:00'
        AND oa.DeliverMode = '01'
        AND oa.user_account IN (
            '92653668', '96771271', '54895238', '90438307',
            '98648853', '85238336', '90081094', '27545589',
            '82379115', '83614969', '93192566', '22607683',
            '24584898', '41327634'
        )
    GROUP BY
        oa.user_account,
        oa.sonid,
        bm.bank_code,
        bm.bank_branch_code,
        bm.bank_account,
        bm.account_name,
        bm.bankname
    HAVING (SUM(oa.TotalAmount) - SUM(oa.Service_fee) -
            (
                SELECT ISNULL(SUM(oa2.TotalAmount), 0)
                FROM Order_Accounting oa2
                INNER JOIN Order_Info oi2
                    ON oa2.LogisticNumber = oi2.LogisticNumber
                    AND oa2.sno = oi2.sno
                WHERE oa2.GrantdaisouDate > '2025-10-15 00:00:00'
                    AND oa2.user_account = oa.user_account
                    AND oa2.sonid = oa.sonid
                    AND oi2.Detail_Status_Description NOT IN ('買家已取件', '消費者成功取件')
            )) < 0  -- ★ 只處理 d < 0 的商家
)
INSERT INTO Grant_History (
    bank_account,
    bank_code,
    bank_branch_code,
    user_account,
    account_name,
    bankname,
    GrantTotalAmount,
    Excel_Name,
    Grant_txtName,
    Grantdate,
    TotalServicefee,
    BulkGrantTotalAmount,
    SettledAmount,
    grant_type
)
SELECT
    bank_account,
    bank_code,
    bank_branch_code,
    user_account,
    account_name,
    bankname,
    -- GrantTotalAmount = d值 (負數欠費金額)
    (TotalAmount - Service_fee - AbnormalAmount) AS GrantTotalAmount,
    -- Excel_Name = 誤撥退貨補救_日期
    '誤撥退貨補救_' + CONVERT(VARCHAR(10), GETDATE(), 112) AS Excel_Name,
    -- Grant_txtName = 空值 (因為沒有實際撥款檔)
    '' AS Grant_txtName,
    -- Grantdate = 今天
    CAST(GETDATE() AS DATE) AS Grantdate,
    -- TotalServicefee = 服務費
    Service_fee AS TotalServicefee,
    -- BulkGrantTotalAmount = 0 (大宗撥款金額)
    0 AS BulkGrantTotalAmount,
    -- SettledAmount = 0 (已結算金額)
    0 AS SettledAmount,
    -- grant_type = 1 (C2C)
    1 AS grant_type
FROM MerchantDebt;

-- 查看插入結果
SELECT @@ROWCOUNT AS '寫入欠費記錄筆數';
```

**執行後會顯示**: `寫入欠費記錄筆數: X`

---

## 步驟 3:驗證寫入結果

### 3-1. 查詢剛寫入的欠費記錄

```sql
-- ========================================
-- 查詢剛寫入的欠費記錄
-- ========================================
SELECT
    gh.user_account,
    bm.mem_Branchwebname AS 商家名稱,
    bm.sonid AS 分店編號,
    gh.bank_code AS 銀行代碼,
    gh.bank_account AS 銀行帳號,
    gh.account_name AS 戶名,
    gh.GrantTotalAmount AS 欠費金額,
    gh.TotalServicefee AS 服務費,
    gh.Excel_Name AS Excel檔名,
    gh.Grantdate AS 欠費日,
    gh.Grant_txtName AS 撥款檔名,
    CASE
        WHEN gh.Grant_txtName IS NULL OR gh.Grant_txtName = '' THEN '未結算'
        ELSE '已結算'
    END AS 結算狀態
FROM Grant_History gh
INNER JOIN Branch_Member bm
    ON gh.user_account = bm.user_account
WHERE gh.Excel_Name LIKE '誤撥退貨補救_%'
    AND gh.user_account IN (
        '92653668', '96771271', '54895238', '90438307',
        '98648853', '85238336', '90081094', '27545589',
        '82379115', '83614969', '93192566', '22607683',
        '24584898', '41327634'
    )
ORDER BY gh.GrantTotalAmount ASC;
```

### 3-2. 統計欠費總額

```sql
-- ========================================
-- 統計欠費總額
-- ========================================
SELECT
    COUNT(DISTINCT user_account) AS 欠費商家數,
    COUNT(*) AS 欠費記錄數,
    SUM(GrantTotalAmount) AS 欠費總額,
    SUM(TotalServicefee) AS 服務費總額
FROM Grant_History
WHERE Excel_Name LIKE '誤撥退貨補救_%'
    AND user_account IN (
        '92653668', '96771271', '54895238', '90438307',
        '98648853', '85238336', '90081094', '27545589',
        '82379115', '83614969', '93192566', '22607683',
        '24584898', '41327634'
    );
```

### 3-3. 對比原始查詢結果

```sql
-- ========================================
-- 對比:步驟1查詢 vs Grant_History 記錄
-- ========================================
WITH OriginalQuery AS (
    -- 步驟1的查詢邏輯
    SELECT
        oa.user_account,
        oa.sonid,
        SUM(oa.TotalAmount) AS TotalAmount,
        SUM(oa.Service_fee) AS Service_fee,
        (
            SELECT ISNULL(SUM(oa2.TotalAmount), 0)
            FROM Order_Accounting oa2
            INNER JOIN Order_Info oi2
                ON oa2.LogisticNumber = oi2.LogisticNumber
                AND oa2.sno = oi2.sno
            WHERE oa2.GrantdaisouDate > '2025-10-15 00:00:00'
                AND oa2.user_account = oa.user_account
                AND oa2.sonid = oa.sonid
                AND oi2.Detail_Status_Description NOT IN ('買家已取件', '消費者成功取件')
        ) AS AbnormalAmount
    FROM Order_Accounting oa
    WHERE oa.GrantdaisouDate > '2025-10-15 00:00:00'
        AND oa.DeliverMode = '01'
        AND oa.user_account IN (
            '92653668', '96771271', '54895238', '90438307',
            '98648853', '85238336', '90081094', '27545589',
            '82379115', '83614969', '93192566', '22607683',
            '24584898', '41327634'
        )
    GROUP BY oa.user_account, oa.sonid
    HAVING (SUM(oa.TotalAmount) - SUM(oa.Service_fee) -
            (
                SELECT ISNULL(SUM(oa2.TotalAmount), 0)
                FROM Order_Accounting oa2
                INNER JOIN Order_Info oi2
                    ON oa2.LogisticNumber = oi2.LogisticNumber
                    AND oa2.sno = oi2.sno
                WHERE oa2.GrantdaisouDate > '2025-10-15 00:00:00'
                    AND oa2.user_account = oa.user_account
                    AND oa2.sonid = oa.sonid
                    AND oi2.Detail_Status_Description NOT IN ('買家已取件', '消費者成功取件')
            )) < 0
),
GrantHistoryRecords AS (
    SELECT
        user_account,
        GrantTotalAmount,
        TotalServicefee
    FROM Grant_History
    WHERE Excel_Name LIKE '誤撥退貨補救_%'
)
SELECT
    COALESCE(oq.user_account, gh.user_account) AS user_account,
    (oq.TotalAmount - oq.Service_fee - oq.AbnormalAmount) AS 原始計算_欠費金額,
    gh.GrantTotalAmount AS Grant_History_欠費金額,
    oq.Service_fee AS 原始計算_服務費,
    gh.TotalServicefee AS Grant_History_服務費,
    CASE
        WHEN ABS((oq.TotalAmount - oq.Service_fee - oq.AbnormalAmount) - gh.GrantTotalAmount) < 1
            AND ABS(oq.Service_fee - gh.TotalServicefee) < 1
        THEN '✅ 一致'
        ELSE '❌ 有差異'
    END AS 比對結果
FROM OriginalQuery oq
FULL OUTER JOIN GrantHistoryRecords gh
    ON oq.user_account = gh.user_account
ORDER BY user_account;
```

---

## 步驟 4:查詢下次撥款時的扣除預覽

```sql
-- ========================================
-- 模擬:下次撥款時會如何扣除這些欠費
-- ========================================
SELECT
    gh.user_account,
    bm.mem_Branchwebname AS 商家名稱,
    gh.GrantTotalAmount AS 欠費金額,
    '下次撥款時會自動扣除' AS 處理說明,
    CASE
        WHEN gh.Grant_txtName IS NULL OR gh.Grant_txtName = ''
        THEN '等待下次撥款'
        ELSE '已於 ' + gh.Grant_txtName + ' 結算'
    END AS 狀態
FROM Grant_History gh
INNER JOIN Branch_Member bm
    ON gh.user_account = bm.user_account
WHERE gh.Excel_Name LIKE '誤撥退貨補救_%'
ORDER BY gh.GrantTotalAmount ASC;
```

**說明**:
- 這些欠費會在商家下次撥款時自動扣除
- 扣除時,`Grant_txtName` 會更新為實際的撥款檔名
- 扣除後,商家額度也會相應減少

---

## ✅ 執行檢查清單

### 執行前

- [ ] 確認會計已手動處理「不撥款」給這14個商家
- [ ] 備份 `Grant_History` 表
- [ ] 執行步驟 2-1 檢查是否已寫入過

### 執行中

- [ ] 執行步驟 1 查詢,確認有哪些商家需要寫欠費 (d < 0)
- [ ] 人工確認查詢結果的金額正確
- [ ] 執行步驟 2-2 INSERT,記錄寫入筆數

### 執行後

- [ ] 執行步驟 3-1 驗證寫入結果
- [ ] 執行步驟 3-2 統計欠費總額
- [ ] 執行步驟 3-3 對比原始查詢,確保一致
- [ ] 將執行結果截圖或匯出,留存記錄

---

## 📊 執行記錄範本

```
執行日期: ____年__月__日
執行人: ________
資料庫: paynowlogistics

步驟1查詢結果:
- 需寫欠費商家數: ____ 家
- 不需處理商家數: ____ 家

步驟2 INSERT結果:
- 寫入欠費記錄筆數: ____

步驟3驗證結果:
- 欠費商家數: ____
- 欠費總額: ______
- 服務費總額: ______
- 對比結果: □ 一致 / □ 有差異

備註:
________________________________________
```

---

## ⚠️ 重要提醒

1. **執行順序務必正確**: 先查詢 → 確認 → INSERT → 驗證
2. **不要重複執行 INSERT**: 執行前先用步驟 2-1 檢查
3. **保留執行記錄**: 截圖或匯出所有查詢結果
4. **通知相關單位**: 執行完成後通知財務和業務
5. **追蹤後續**: 下次撥款時確認欠費是否正確扣除

---

## 🔗 相關文件

- 原始補壓邏輯: `../補壓代收請款日_完整步驟.md`
- 修正後補壓邏輯: `./補壓代收請款日_排除退貨版.md`
- 執行記錄: `./執行記錄/`
