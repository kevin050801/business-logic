# 2025-10-17 誤撥退貨訂單事件處理記錄

## 事件概述

**發生日期**: 2025-10-17
**發現時間**: 2025-10-18
**事件類型**: 代收款誤撥
**影響範圍**: 14 個商家帳號

### 問題描述

在執行 2025-10-17 的 C2C 撥款時,系統處理了部分退貨訂單的代收款撥給商家。這些訂單雖然 `ReconciliationResult='Y'`(核帳通過),但實際上是退貨訂單(`Detail_Status_Description` 不是 '買家已取件' 或 '消費者成功取件'),不應該撥款給商家。

### 根本原因

**補壓代收請款日流程未過濾退貨訂單**

在執行「補壓代收請款日_完整步驟.md」時,只檢查了 `ReconciliationResult='Y'`,但沒有檢查訂單狀態,導致退貨訂單也被納入撥款範圍。

**相關代碼位置**:
- `OrderController.cs:799` - Grant_AndC2CReport 方法
- 缺少 `Detail_Status_Description` 的檢查邏輯

### 影響商家清單

共 14 個商家帳號受影響:

```
'22607683', '24584898', '27545589', '41327634', '54895238',
'82379115', '83614969', '85238336', '90081094', '90438307',
'92653668', '93192566', '96771271', '98648853'
```

---

## 處理步驟

### 前置作業

#### 1. 確認異常訂單範圍

使用以下 SQL 確認有異常訂單的商家:

```sql
WITH MerchantSummary AS (
    SELECT
        oa.user_account,
        oa.sonid,
        bm.mem_Branchwebname AS MerchantName,
        SUM(oa.TotalAmount) AS TotalAmount,
        SUM(oa.Service_fee) AS Service_fee,
        (
            SELECT ISNULL(SUM(oa2.TotalAmount), 0)
            FROM Order_Accounting oa2
            INNER JOIN Order_Info oi2
                ON oa2.LogisticNumber = oi2.LogisticNumber
                AND oa2.sno = oi2.sno
            WHERE oa2.GrantdaisouDate = '2025-10-17 00:00:00'
                AND oa2.user_account = oa.user_account
                AND oa2.sonid = oa.sonid
                AND oi2.Detail_Status_Description NOT IN ('買家已取件', '消費者成功取件')
        ) AS AbnormalAmount,
        (
            SELECT COUNT(*)
            FROM Order_Accounting oa2
            INNER JOIN Order_Info oi2
                ON oa2.LogisticNumber = oi2.LogisticNumber
                AND oa2.sno = oi2.sno
            WHERE oa2.GrantdaisouDate = '2025-10-17 00:00:00'
                AND oa2.user_account = oa.user_account
                AND oa2.sonid = oa.sonid
                AND oi2.Detail_Status_Description NOT IN ('買家已取件', '消費者成功取件')
        ) AS AbnormalOrders
    FROM Order_Accounting oa
    INNER JOIN Branch_Member bm
        ON oa.user_account = bm.user_account
        AND oa.sonid = bm.sonid
    WHERE oa.GrantdaisouDate = '2025-10-17 00:00:00'
        AND oa.DeliverMode = '01'
    GROUP BY
        oa.user_account,
        oa.sonid,
        bm.mem_Branchwebname
)
SELECT *
FROM MerchantSummary
WHERE AbnormalOrders > 0
ORDER BY user_account, sonid;
```

**查詢結果**: 14 個商家有異常訂單

---

### 步驟 1: 檢查假性結清的歷史欠費

**目的**: 確認是否有歷史欠費因為誤撥金額而被錯誤結清

```sql
-- ========================================
-- 步驟 1: 檢查假性結清的歷史欠費
-- ========================================
WITH 本次異常統計 AS (
    SELECT
        oa.user_account,
        SUM(oa.TotalAmount) AS 本次總代收,
        SUM(oa.Service_fee) AS 本次服務費,
        SUM(CASE
            WHEN oi.Detail_Status_Description NOT IN ('買家已取件', '消費者成功取件')
            THEN oa.TotalAmount
            ELSE 0
        END) AS 異常代收款
    FROM Order_Accounting oa
    INNER JOIN Order_Info oi
        ON oa.LogisticNumber = oi.LogisticNumber
        AND oa.sno = oi.sno
    WHERE oa.GrantdaisouDate = '2025-10-17 00:00:00'
        AND oa.DeliverMode = '01'
    GROUP BY oa.user_account
),
本次被結清的歷史欠費 AS (
    SELECT
        user_account,
        GrantTotalAmount AS 欠費金額,
        Grantdate AS 原始欠費日期,
        Grant_txtName
    FROM Grant_History
    WHERE (Grant_txtName = '2025-10-17GrantReport.txt'
           OR Grant_txtName = '2025-10-17GrantReport[1].txt')
    AND user_account IN (
        '22607683', '24584898', '27545589', '41327634', '54895238',
        '82379115', '83614969', '85238336', '90081094', '90438307',
        '92653668', '93192566', '96771271', '98648853'
    )
)

SELECT
    b.user_account,
    b.欠費金額,
    b.原始欠費日期,
    b.Grant_txtName,
    (a.本次總代收 - a.本次服務費) AS 系統計算的撥款,
    (a.本次總代收 - a.本次服務費 - a.異常代收款) AS 正確的撥款,
    ABS(b.欠費金額) AS 需要結清的金額,
    CASE
        WHEN (a.本次總代收 - a.本次服務費 - a.異常代收款) >= ABS(b.欠費金額)
            THEN '✅ 足夠結清'
        ELSE '❌ 假性結清-需清空txtName'
    END AS 判斷結果,
    'UPDATE Grant_History SET Grant_txtName = '''' WHERE user_account = ''' +
    b.user_account + ''' AND GrantTotalAmount = ' + CAST(b.欠費金額 AS NVARCHAR) +
    ' AND Grantdate = ''' + CONVERT(VARCHAR(10), b.原始欠費日期, 120) +
    ''' AND Grant_txtName = ''' + b.Grant_txtName + ''';' AS 處理SQL
FROM 本次被結清的歷史欠費 b
INNER JOIN 本次異常統計 a ON b.user_account = a.user_account
WHERE (a.本次總代收 - a.本次服務費 - a.異常代收款) < ABS(b.欠費金額)
ORDER BY b.user_account, b.原始欠費日期;
```

**執行結果**:
- 查詢筆數: X 筆
- 需清空 txtName 的筆數: X 筆
- 執行 UPDATE SQL (如果有假性結清)

---

### 步驟 2: 更正本次正數撥款金額

**目的**: 扣除誤撥的異常代收款,更新 Grant_History 的 GrantTotalAmount

```sql
-- ========================================
-- 步驟 2: 計算正數撥款需要扣除的金額
-- ========================================
WITH 本次異常統計 AS (
    SELECT * FROM (
        SELECT
            oa.user_account,
            SUM(CASE
                WHEN oi.Detail_Status_Description NOT IN ('買家已取件', '消費者成功取件')
                THEN oa.TotalAmount
                ELSE 0
            END) AS 異常代收款
        FROM Order_Accounting oa
        INNER JOIN Order_Info oi
            ON oa.LogisticNumber = oi.LogisticNumber
            AND oa.sno = oi.sno
        WHERE oa.GrantdaisouDate = '2025-10-17 00:00:00'
            AND oa.DeliverMode = '01'
        GROUP BY oa.user_account
    ) a
    WHERE 異常代收款 > 0
),
本次正數撥款 AS (
    SELECT
        user_account,
        GrantTotalAmount,
        TotalServicefee,
        Grantdate,
        Grant_txtName,
        bank_account,
        bank_code,
        bank_branch_code,
        account_name,
        bankname,
        Excel_Name
    FROM Grant_History
    WHERE (Grant_txtName = 'D:\Logistic_Grant_txt\2025-10-17GrantReport.txt'
           OR Grant_txtName = 'D:\Logistic_Grant_txt\2025-10-17GrantReport[1].txt')
    AND GrantTotalAmount > 0
    AND user_account IN (
        '22607683', '24584898', '27545589', '41327634', '54895238',
        '82379115', '83614969', '85238336', '90081094', '90438307',
        '92653668', '93192566', '96771271', '98648853'
    )
)

SELECT
    g.user_account,
    g.Grant_txtName,
    g.GrantTotalAmount AS 原始撥款金額,
    g.TotalServicefee AS 服務費,
    ISNULL(a.異常代收款, 0) AS 需扣除的誤撥金額,
    g.GrantTotalAmount - ISNULL(a.異常代收款, 0) AS 扣除後金額,
    CASE
        WHEN g.GrantTotalAmount - ISNULL(a.異常代收款, 0) > 0
            THEN '✅ 更新為: ' + CAST(g.GrantTotalAmount - ISNULL(a.異常代收款, 0) AS NVARCHAR)
        WHEN g.GrantTotalAmount - ISNULL(a.異常代收款, 0) = 0
            THEN '⚠️ 歸零-需刪除此記錄'
        ELSE '❌ 負數-需刪除此記錄並新增欠費'
    END AS 處理方式,
    -- UPDATE SQL
    CASE
        WHEN g.GrantTotalAmount - ISNULL(a.異常代收款, 0) > 0
            THEN 'UPDATE Grant_History SET GrantTotalAmount = ' +
                 CAST(g.GrantTotalAmount - ISNULL(a.異常代收款, 0) AS NVARCHAR) +
                 ' WHERE user_account = ''' + g.user_account +
                 ''' AND GrantTotalAmount = ' + CAST(g.GrantTotalAmount AS NVARCHAR) +
                 ' AND Grant_txtName = ''' + g.Grant_txtName +
                 ''' AND Grantdate = ''' + CONVERT(VARCHAR(10), g.Grantdate, 120) + ''';'
        ELSE NULL
    END AS UPDATE_SQL,
    -- DELETE SQL
    CASE
        WHEN g.GrantTotalAmount - ISNULL(a.異常代收款, 0) <= 0
            THEN 'DELETE FROM Grant_History WHERE user_account = ''' + g.user_account +
                 ''' AND GrantTotalAmount = ' + CAST(g.GrantTotalAmount AS NVARCHAR) +
                 ' AND Grant_txtName = ''' + g.Grant_txtName +
                 ''' AND Grantdate = ''' + CONVERT(VARCHAR(10), g.Grantdate, 120) + ''';'
        ELSE NULL
    END AS DELETE_SQL,
    -- INSERT SQL (新增欠費)
    CASE
        WHEN g.GrantTotalAmount - ISNULL(a.異常代收款, 0) < 0
            THEN 'INSERT INTO Grant_History (bank_account, bank_code, bank_branch_code, user_account, ' +
                 'account_name, bankname, GrantTotalAmount, Excel_Name, Grant_txtName, Grantdate, ' +
                 'TotalServicefee, grant_type) VALUES (''' +
                 g.bank_account + ''', ''' + g.bank_code + ''', ''' + g.bank_branch_code + ''', ''' +
                 g.user_account + ''', ''' + g.account_name + ''', ''' + g.bankname + ''', ' +
                 CAST(g.GrantTotalAmount - ISNULL(a.異常代收款, 0) AS NVARCHAR) + ', ''' +
                 g.Excel_Name + ''', '''', ''' + CONVERT(VARCHAR(10), g.Grantdate, 120) + ''', ' +
                 CAST(g.TotalServicefee AS NVARCHAR) + ', 1);'
        ELSE NULL
    END AS INSERT_SQL
FROM 本次正數撥款 g
LEFT JOIN 本次異常統計 a ON g.user_account = a.user_account
WHERE ISNULL(a.異常代收款, 0) > 0
ORDER BY g.user_account;
```

**執行結果**:
- 總共處理商家數: 14 筆
- UPDATE (扣除後仍為正數): X 筆
- DELETE + INSERT (扣除後變負數): X 筆
- DELETE (扣除後歸零): X 筆

---

### 步驟 3: 驗證處理結果

```sql
-- 驗證 Grant_History 更新結果
SELECT
    user_account,
    GrantTotalAmount,
    Grant_txtName,
    Grantdate,
    TotalServicefee,
    CASE
        WHEN GrantTotalAmount > 0 AND Grant_txtName LIKE 'D:\%2025-10-17%'
            THEN '本次正數撥款(已更正)'
        WHEN GrantTotalAmount < 0 AND Grant_txtName LIKE '2025-10-17%' AND Grant_txtName NOT LIKE 'D:\%'
            THEN '歷史欠費-已結清'
        WHEN GrantTotalAmount < 0 AND Grant_txtName = ''
            THEN '欠費-未結清'
        ELSE '其他'
    END AS 記錄類型
FROM Grant_History
WHERE user_account IN (
    '22607683', '24584898', '27545589', '41327634', '54895238',
    '82379115', '83614969', '85238336', '90081094', '90438307',
    '92653668', '93192566', '96771271', '98648853'
)
AND (
    Grant_txtName LIKE '%2025-10-17%'
    OR (Grant_txtName = '' AND Grantdate >= '2025-10-17')
)
ORDER BY user_account, GrantTotalAmount DESC;
```

---

## 處理結果總結

### 異動統計

| 項目 | 筆數 | 說明 |
|-----|------|------|
| 受影響商家數 | 14 | 有異常訂單的商家帳號 |
| 假性結清欠費 | X | Grant_txtName 清空為 '' |
| 更新正數撥款 | X | GrantTotalAmount 扣除異常金額 |
| 刪除並新增欠費 | X | 扣除後變負數 |
| 刪除歸零記錄 | X | 扣除後剛好為 0 |

### 財務影響

| 項目 | 金額 (元) |
|-----|----------|
| 誤撥總金額 | XXX,XXX |
| 實際應撥金額 | XXX,XXX |
| 差異金額 | XXX,XXX |

---

## 後續追蹤

### 系統改善

1. ✅ 已更新「補壓代收請款日_排除退貨版.md」,加入訂單狀態檢查
2. ⏳ 待評估:是否需要在 Grant_AndC2CReport 方法中加入訂單狀態檢查邏輯
3. ⏳ 待建立:會計人員可自行執行的「補壓代收請款日」功能

### 文件更新

- ✅ 建立「2025-10-17_誤撥退貨訂單事件處理記錄.md」
- ✅ 更新「補壓代收請款日_排除退貨版.md」

---

## 執行人員與時間

- **發現人員**: [填寫]
- **處理人員**: [填寫]
- **執行日期**: 2025-10-18
- **完成時間**: [填寫]
- **複核人員**: [填寫]

---

## 備註

1. 本次會計已手動不撥款給這 14 個商家,無需額外追討
2. Grant_History 已更正為正確金額
3. 歷史欠費的結清狀態已恢復
4. 未來執行「補壓代收請款日」時,請使用「排除退貨版」的 SQL
