# 補壓 10/1、10/8 代收請款日完整步驟

## 背景說明

因 10/1、10/8 連假關係，週三排程（WeeklySettlement）沒有執行，導致該週期的代收請款日（CheckoutdaisouDate）沒有壓入。

### 排程邏輯

**每週三凌晨 1:10 執行 `WeeklySettlement`**：
- 時間計算：週三往回推 9 天開始，持續 7 天
- 10/1 (週三)：處理 9/22-9/29 的訂單
- 10/8 (週三)：處理 9/29-10/6 的訂單
- 10/15 (週三)：處理 10/6-10/13 的訂單

### 請款與代收請款的差異

| 項目 | 一般請款 (CheckoutDate) | 代收請款 (CheckoutdaisouDate) |
|------|------------------------|------------------------------|
| **觸發條件** | respcode = '0101' (取貨門市已驗收) | respcode = '8000' (結案) |
| **需要核帳檔** | ❌ 不需要 | ✅ 需要 `ReconciliationResult='Y'` |
| **排程時機** | 有取件就壓 | 有結案且有核帳檔才壓 |

**目前狀況**：
- ✅ `CheckoutDate` 已經有填入（有取件記錄就會壓）
- ❌ `CheckoutdaisouDate` 沒有填入（連假沒有核帳檔）
- ✅ 現在核帳檔已補齊（`ReconciliationResult='Y'`）

---

## 涉及的物流服務

### C2C 交貨便/店到店（有請款 + 代收請款）
- **01** - 7-11 交貨便
- **03** - 全家 交貨便
- **05** - 萊爾富 交貨便
- **10** - OK 交貨便
- **23** - 全家冷凍 C2C

### 特殊 C2C（只有代收請款，無一般請款）
- **21** - 7-11 冷凍 C2C：使用扣點數，`CheckoutDate` 永遠是 NULL，只做代收請款

### 大宗快撥（有請款 + 代收請款）
- **02** - 7-11 大宗 B2C (advance_Granted='1')
- **04** - 全家 大宗 B2C (advance_Granted='1')
- **22** - 7-11 冷凍大宗 B2C (advance_Granted='1')
- **24** - 全家冷凍大宗 B2C (advance_Granted='1')

---

## 執行步驟

### 步驟 0：總覽查詢（先看全部需要補壓的訂單）

```sql
-- ========================================
-- 總覽 - 查詢所有需要補壓代收請款日的訂單
-- ========================================
SELECT
    CASE
        WHEN oa.CheckoutDate >= '2025-09-22' AND oa.CheckoutDate < '2025-09-29' THEN '2025-10-01'
        WHEN oa.CheckoutDate >= '2025-09-29' AND oa.CheckoutDate < '2025-10-06' THEN '2025-10-08'
        WHEN oa.CheckoutDate >= '2025-10-06' AND oa.CheckoutDate < '2025-10-13' THEN '2025-10-15'
        ELSE NULL
    END AS ShouldCheckoutDaisouDate,
    Logistic_service,
    CASE
        WHEN Logistic_service IN ('01','03','05','10','23') THEN 'C2C交貨便'
        WHEN Logistic_service IN ('02','04','22','24') THEN '大宗快撥'
        ELSE '其他'
    END AS ServiceType,
    COUNT(*) as OrderCount,
    SUM(TotalAmount) as TotalAmount
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
WHERE oa.CheckoutDate >= '2025-09-22 00:00:00'
    AND oa.CheckoutDate < '2025-10-13 00:00:00'
    AND (
        -- C2C 交貨便/店到店（排除21）
        oa.Logistic_service IN ('01','03','05','10','23')
        OR
        -- 大宗快撥
        (oa.Logistic_service IN ('02','04','22','24') AND oa.advance_Granted = '1')
    )
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    )
GROUP BY
    CASE
        WHEN oa.CheckoutDate >= '2025-09-22' AND oa.CheckoutDate < '2025-09-29' THEN '2025-10-01'
        WHEN oa.CheckoutDate >= '2025-09-29' AND oa.CheckoutDate < '2025-10-06' THEN '2025-10-08'
        WHEN oa.CheckoutDate >= '2025-10-06' AND oa.CheckoutDate < '2025-10-13' THEN '2025-10-15'
        ELSE NULL
    END,
    Logistic_service
ORDER BY ShouldCheckoutDaisouDate, Logistic_service;
```

```sql
-- ========================================
-- 總覽 - 查詢 21 (7-11冷凍C2C) 需要補壓的訂單
-- ========================================
SELECT
    CASE
        WHEN lph.datadatetime >= '2025-09-22' AND lph.datadatetime < '2025-09-29' THEN '2025-10-01'
        WHEN lph.datadatetime >= '2025-09-29' AND lph.datadatetime < '2025-10-06' THEN '2025-10-08'
        WHEN lph.datadatetime >= '2025-10-06' AND lph.datadatetime < '2025-10-13' THEN '2025-10-15'
        ELSE NULL
    END AS ShouldCheckoutDaisouDate,
    COUNT(*) as OrderCount
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
INNER JOIN (
    SELECT DISTINCT
        CAST(LogisticNumber AS VARCHAR) AS LogisticNumber,
        CAST(paymentno AS VARCHAR) AS paymentno,
        datadatetime
    FROM LogisticProcessHistory
    WHERE datadatetime >= '2025-09-22 00:00:00'
        AND datadatetime < '2025-10-13 00:00:00'
        AND respcode = '8000'
        AND FileTitle = 'NPPS'
        AND LogisticServiceID = '21'
) lph
    ON oa.LogisticNumber = lph.LogisticNumber
    AND oa.paymentno = lph.paymentno
WHERE oa.Logistic_service = '21'
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oa.CheckoutDate IS NULL
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    )
GROUP BY
    CASE
        WHEN lph.datadatetime >= '2025-09-22' AND lph.datadatetime < '2025-09-29' THEN '2025-10-01'
        WHEN lph.datadatetime >= '2025-09-29' AND lph.datadatetime < '2025-10-06' THEN '2025-10-08'
        WHEN lph.datadatetime >= '2025-10-06' AND lph.datadatetime < '2025-10-13' THEN '2025-10-15'
        ELSE NULL
    END
ORDER BY ShouldCheckoutDaisouDate;
```

---

### 步驟 1：查詢並補壓 10/1 的代收請款日（一般 C2C + 大宗快撥）

#### 1-1. 先查詢確認筆數

```sql
-- ========================================
-- SELECT - 10/1 應該壓的代收請款（9/22-9/28）
-- ========================================
SELECT
    COUNT(*) as TotalRows,
    Logistic_service,
    COUNT(*) as ServiceCount
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
WHERE oa.CheckoutDate >= '2025-09-22 00:00:00'
    AND oa.CheckoutDate < '2025-09-29 00:00:00'
    AND (
        oa.Logistic_service IN ('01','03','05','10','23')
        OR
        (oa.Logistic_service IN ('02','04','22','24') AND oa.advance_Granted = '1')
    )
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    )
GROUP BY Logistic_service;
```

#### 1-2. 確認無誤後執行更新

```sql
-- ========================================
-- UPDATE - 10/1 應該壓的代收請款（9/22-9/28）
-- ========================================
UPDATE oa
SET CheckoutdaisouDate = '2025-10-01'
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
WHERE oa.CheckoutDate >= '2025-09-22 00:00:00'
    AND oa.CheckoutDate < '2025-09-29 00:00:00'
    AND (
        -- C2C 交貨便/店到店
        oa.Logistic_service IN ('01','03','05','10','23')
        OR
        -- 大宗快撥
        (oa.Logistic_service IN ('02','04','22','24') AND oa.advance_Granted = '1')
    )
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    );

-- 查看更新筆數
SELECT @@ROWCOUNT as UpdatedRows;
```

### 步驟 2：查詢並補壓 10/8 的代收請款日（一般 C2C + 大宗快撥）

#### 2-1. 先查詢確認筆數

```sql
-- ========================================
-- SELECT - 10/8 應該壓的代收請款（9/29-10/5）
-- ========================================
SELECT
    COUNT(*) as TotalRows,
    Logistic_service,
    COUNT(*) as ServiceCount
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
WHERE oa.CheckoutDate >= '2025-09-29 00:00:00'
    AND oa.CheckoutDate < '2025-10-06 00:00:00'
    AND (
        oa.Logistic_service IN ('01','03','05','10','23')
        OR
        (oa.Logistic_service IN ('02','04','22','24') AND oa.advance_Granted = '1')
    )
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    )
GROUP BY Logistic_service;
```

#### 2-2. 確認無誤後執行更新

```sql
-- ========================================
-- UPDATE - 10/8 應該壓的代收請款（9/29-10/5）
-- ========================================
UPDATE oa
SET CheckoutdaisouDate = '2025-10-08'
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
WHERE oa.CheckoutDate >= '2025-09-29 00:00:00'
    AND oa.CheckoutDate < '2025-10-06 00:00:00'
    AND (
        -- C2C 交貨便/店到店
        oa.Logistic_service IN ('01','03','05','10','23')
        OR
        -- 大宗快撥
        (oa.Logistic_service IN ('02','04','22','24') AND oa.advance_Granted = '1')
    )
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    );

-- 查看更新筆數
SELECT @@ROWCOUNT as UpdatedRows;
```

### 步驟 3：查詢並補壓 10/15 的代收請款日（一般 C2C + 大宗快撥）

#### 3-1. 先查詢確認筆數

```sql
-- ========================================
-- SELECT - 10/15 應該壓的代收請款（10/6-10/12）
-- ========================================
SELECT
    COUNT(*) as TotalRows,
    Logistic_service,
    COUNT(*) as ServiceCount
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
WHERE oa.CheckoutDate >= '2025-10-06 00:00:00'
    AND oa.CheckoutDate < '2025-10-13 00:00:00'
    AND (
        oa.Logistic_service IN ('01','03','05','10','23')
        OR
        (oa.Logistic_service IN ('02','04','22','24') AND oa.advance_Granted = '1')
    )
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    )
GROUP BY Logistic_service;
```

#### 3-2. 確認無誤後執行更新

```sql
-- ========================================
-- UPDATE - 10/15 應該壓的代收請款（10/6-10/12）
-- ========================================
UPDATE oa
SET CheckoutdaisouDate = '2025-10-15'
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
WHERE oa.CheckoutDate >= '2025-10-06 00:00:00'
    AND oa.CheckoutDate < '2025-10-13 00:00:00'
    AND (
        oa.Logistic_service IN ('01','03','05','10','23')
        OR
        (oa.Logistic_service IN ('02','04','22','24') AND oa.advance_Granted = '1')
    )
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    );

-- 查看更新筆數
SELECT @@ROWCOUNT as UpdatedRows;
```

---

### 步驟 4：查詢並補壓 10/1 的代收請款日（21 - 7-11冷凍C2C）

#### 4-1. 先查詢確認筆數

```sql
-- ========================================
-- SELECT - 21 補壓 10/1 的代收請款（物流歷程時間在 9/22-9/28）
-- ========================================
SELECT
    COUNT(*) as TotalRows
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
INNER JOIN (
    SELECT DISTINCT
        CAST(LogisticNumber AS VARCHAR) AS LogisticNumber,
        CAST(paymentno AS VARCHAR) AS paymentno
    FROM LogisticProcessHistory
    WHERE datadatetime >= '2025-09-22 00:00:00'
        AND datadatetime < '2025-09-29 00:00:00'
        AND respcode = '8000'
        AND FileTitle = 'NPPS'
        AND LogisticServiceID = '21'
) lph
    ON oa.LogisticNumber = lph.LogisticNumber
    AND oa.paymentno = lph.paymentno
WHERE oa.Logistic_service = '21'
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oa.CheckoutDate IS NULL
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    );
```

#### 4-2. 確認無誤後執行更新

```sql
-- ========================================
-- UPDATE - 21 補壓 10/1 的代收請款（物流歷程時間在 9/22-9/28）
-- ========================================
UPDATE oa
SET CheckoutdaisouDate = '2025-10-01'
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
INNER JOIN (
    SELECT DISTINCT
        CAST(LogisticNumber AS VARCHAR) AS LogisticNumber,
        CAST(paymentno AS VARCHAR) AS paymentno
    FROM LogisticProcessHistory
    WHERE datadatetime >= '2025-09-22 00:00:00'
        AND datadatetime < '2025-09-29 00:00:00'
        AND respcode = '8000'
        AND FileTitle = 'NPPS'
        AND LogisticServiceID = '21'
) lph
    ON oa.LogisticNumber = lph.LogisticNumber
    AND oa.paymentno = lph.paymentno
WHERE oa.Logistic_service = '21'
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oa.CheckoutDate IS NULL
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    );

-- 查看更新筆數
SELECT @@ROWCOUNT as UpdatedRows;
```

### 步驟 5：查詢並補壓 10/8 的代收請款日（21 - 7-11冷凍C2C）

#### 5-1. 先查詢確認筆數

```sql
-- ========================================
-- SELECT - 21 補壓 10/8 的代收請款（物流歷程時間在 9/29-10/5）
-- ========================================
SELECT
    COUNT(*) as TotalRows
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
INNER JOIN (
    SELECT DISTINCT
        CAST(LogisticNumber AS VARCHAR) AS LogisticNumber,
        CAST(paymentno AS VARCHAR) AS paymentno
    FROM LogisticProcessHistory
    WHERE datadatetime >= '2025-09-29 00:00:00'
        AND datadatetime < '2025-10-06 00:00:00'
        AND respcode = '8000'
        AND FileTitle = 'NPPS'
        AND LogisticServiceID = '21'
) lph
    ON oa.LogisticNumber = lph.LogisticNumber
    AND oa.paymentno = lph.paymentno
WHERE oa.Logistic_service = '21'
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oa.CheckoutDate IS NULL
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    );
```

#### 5-2. 確認無誤後執行更新

```sql
-- ========================================
-- UPDATE - 21 補壓 10/8 的代收請款（物流歷程時間在 9/29-10/5）
-- ========================================
UPDATE oa
SET CheckoutdaisouDate = '2025-10-08'
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
INNER JOIN (
    SELECT DISTINCT
        CAST(LogisticNumber AS VARCHAR) AS LogisticNumber,
        CAST(paymentno AS VARCHAR) AS paymentno
    FROM LogisticProcessHistory
    WHERE datadatetime >= '2025-09-29 00:00:00'
        AND datadatetime < '2025-10-06 00:00:00'
        AND respcode = '8000'
        AND FileTitle = 'NPPS'
        AND LogisticServiceID = '21'
) lph
    ON oa.LogisticNumber = lph.LogisticNumber
    AND oa.paymentno = lph.paymentno
WHERE oa.Logistic_service = '21'
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oa.CheckoutDate IS NULL
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    );

-- 查看更新筆數
SELECT @@ROWCOUNT as UpdatedRows;
```

### 步驟 6：查詢並補壓 10/15 的代收請款日（21 - 7-11冷凍C2C）

#### 6-1. 先查詢確認筆數

```sql
-- ========================================
-- SELECT - 21 補壓 10/15 的代收請款（物流歷程時間在 10/6-10/12）
-- ========================================
SELECT
    COUNT(*) as TotalRows
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
INNER JOIN (
    SELECT DISTINCT
        CAST(LogisticNumber AS VARCHAR) AS LogisticNumber,
        CAST(paymentno AS VARCHAR) AS paymentno
    FROM LogisticProcessHistory
    WHERE datadatetime >= '2025-10-06 00:00:00'
        AND datadatetime < '2025-10-13 00:00:00'
        AND respcode = '8000'
        AND FileTitle = 'NPPS'
        AND LogisticServiceID = '21'
) lph
    ON oa.LogisticNumber = lph.LogisticNumber
    AND oa.paymentno = lph.paymentno
WHERE oa.Logistic_service = '21'
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oa.CheckoutDate IS NULL
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    );
```

#### 6-2. 確認無誤後執行更新

```sql
-- ========================================
-- UPDATE - 21 補壓 10/15 的代收請款（物流歷程時間在 10/6-10/12）
-- ========================================
UPDATE oa
SET CheckoutdaisouDate = '2025-10-15'
FROM Order_Accounting oa
INNER JOIN Order_Info oi
    ON oa.LogisticNumber = oi.LogisticNumber
    AND oa.sno = oi.sno
INNER JOIN Branch_Member bm
    ON oa.user_account = bm.user_account
    AND oa.sonid = bm.sonid
INNER JOIN (
    SELECT DISTINCT
        CAST(LogisticNumber AS VARCHAR) AS LogisticNumber,
        CAST(paymentno AS VARCHAR) AS paymentno
    FROM LogisticProcessHistory
    WHERE datadatetime >= '2025-10-06 00:00:00'
        AND datadatetime < '2025-10-13 00:00:00'
        AND respcode = '8000'
        AND FileTitle = 'NPPS'
        AND LogisticServiceID = '21'
) lph
    ON oa.LogisticNumber = lph.LogisticNumber
    AND oa.paymentno = lph.paymentno
WHERE oa.Logistic_service = '21'
    AND oa.DeliverMode = '01'
    AND oa.Checkoutable = '1'
    AND oi.ReconciliationResult = 'Y'
    AND oa.CheckoutDate IS NULL
    AND oa.CheckoutdaisouDate IS NULL
    AND oa.GrantdaisouDate IS NULL
    AND bm.user_account NOT IN (
        SELECT user_account
        FROM Additional_SetUP
        WHERE stop_grant = '1'
    );

-- 查看更新筆數
SELECT @@ROWCOUNT as UpdatedRows;
```

---

### 步驟 7：驗證更新結果

```sql
-- ========================================
-- 驗證 - 查看更新結果（分物流類型和日期）
-- ========================================
SELECT
    CheckoutdaisouDate,
    Logistic_service,
    CASE
        WHEN Logistic_service IN ('01','03','05','10','23') THEN 'C2C交貨便'
        WHEN Logistic_service = '21' THEN 'C2C冷凍(21)'
        WHEN Logistic_service IN ('02','04','22','24') THEN '大宗快撥'
        ELSE '其他'
    END AS ServiceType,
    advance_Granted,
    COUNT(*) as OrderCount,
    SUM(TotalAmount) as TotalAmount
FROM Order_Accounting
WHERE CheckoutdaisouDate IN ('2025-10-01', '2025-10-08', '2025-10-15')
    AND (
        Logistic_service IN ('01','03','05','10','21','23')
        OR
        (Logistic_service IN ('02','04','22','24') AND advance_Granted = '1')
    )
GROUP BY CheckoutdaisouDate, Logistic_service, advance_Granted
ORDER BY CheckoutdaisouDate, Logistic_service;
```

---

## 執行順序總結

### 一般 C2C + 大宗快撥（01, 03, 05, 10, 23, 02快撥, 04快撥, 22快撥, 24快撥）
1. **步驟 1**：查詢並補壓 10/1（9/22-9/28）
   - 1-1. SELECT 確認筆數
   - 1-2. UPDATE 更新

2. **步驟 2**：查詢並補壓 10/8（9/29-10/5）
   - 2-1. SELECT 確認筆數
   - 2-2. UPDATE 更新

3. **步驟 3**：查詢並補壓 10/15（10/6-10/12）
   - 3-1. SELECT 確認筆數
   - 3-2. UPDATE 更新

### 特殊 C2C - 21 (7-11冷凍C2C)
4. **步驟 4**：查詢並補壓 10/1（物流歷程 9/22-9/28）
   - 4-1. SELECT 確認筆數
   - 4-2. UPDATE 更新

5. **步驟 5**：查詢並補壓 10/8（物流歷程 9/29-10/5）
   - 5-1. SELECT 確認筆數
   - 5-2. UPDATE 更新

6. **步驟 6**：查詢並補壓 10/15（物流歷程 10/6-10/12）
   - 6-1. SELECT 確認筆數
   - 6-2. UPDATE 更新

### 驗證
7. **步驟 7**：驗證更新結果（查看所有更新統計）

---

## 後續動作

補壓完成後，在 **10/15 (週三) 執行撥款操作**時：
- 系統會自動抓取 `CheckoutdaisouDate IS NOT NULL` 且 `GrantdaisouDate IS NULL` 的訂單
- 執行 `Grant_AndC2CReport` 撥款功能
- 系統會自動填入 `GrantdaisouDate = 2025-10-15`
- 這樣就完成了 10/1、10/8、10/15 三次的代收撥款

---

## 重要提醒

1. ✅ **執行前先用 SELECT 確認筆數**，確保條件正確
2. ✅ **分批執行**，不要一次執行全部（先做 10/1，確認無誤後再做 10/8）
3. ✅ **記錄每次更新的筆數**，以便事後追蹤
4. ✅ **注意 21 的處理邏輯不同**，是根據物流歷程時間，不是 CheckoutDate
5. ⚠️ 如果某些訂單的 `ReconciliationResult` 不是 'Y'，就算執行 UPDATE 也不會成功
