# 代收款管理文件總覽

本目錄包含物流代收款管理相關的所有文件,包括日常查詢、補壓流程、欠費處理、誤撥事件記錄等。

---

## 📁 文件結構

```
grant-management/
├── README.md                                    # 本文件
├── 補壓代收請款日_完整步驟.md                     # 原始版本(無退貨過濾)
├── 補壓代收請款日_通用流程(會計專用).md            # 會計專用簡化版
├── 查詢_Grant_History撥款與欠費記錄.md            # Grant_History查詢大全
└── 代收款誤撥處理/
    ├── 2025-10-17_誤撥退貨訂單事件處理記錄.md     # 具體事件處理記錄
    ├── 補壓代收請款日_排除退貨版.md                # ⭐ 修正版(建議使用)
    └── 執行記錄/                                  # 歷史執行記錄資料夾
        └── (其他歷史文件...)
```

---

## 📚 文件說明

### 1. 日常查詢類

#### 📄 查詢_Grant_History撥款與欠費記錄.md
**用途**: Grant_History 表的查詢工具箱
**適用對象**: 會計、財務、開發人員
**內容**:
- Grant_txtName 的三種狀態說明
- 8 種常用查詢 SQL
- 商家對帳、欠費追蹤、異常診斷

**使用時機**:
- ✅ 查詢商家撥款記錄
- ✅ 追蹤未結清欠費
- ✅ 月結對帳
- ✅ 除錯資料異常

---

### 2. 補壓代收請款日類

#### 📄 補壓代收請款日_通用流程(會計專用).md ⭐ **推薦**
**用途**: 會計人員手動補壓代收請款日的簡化版流程
**適用對象**: 會計人員
**內容**:
- 簡化的操作步驟
- 日期計算公式
- 快速操作範例
- 執行記錄範本

**使用時機**:
- ✅ 連假期間排程沒執行
- ✅ 核帳檔延遲提供
- ✅ 手動補單需要補壓

**特色**:
- 📌 已包含退貨過濾邏輯
- 📌 操作步驟精簡
- 📌 適合非技術人員使用

---

#### 📄 補壓代收請款日_完整步驟.md
**用途**: 完整版補壓流程(不含退貨過濾)
**適用對象**: 開發人員、進階使用者
**內容**:
- 詳細的背景說明
- 分步驟的 SQL(01, 03, 05, 10, 23, 21, 02-04快撥)
- 排程邏輯說明

**使用時機**:
- 📖 了解完整的補壓邏輯
- 📖 作為開發參考文件

**⚠️ 注意**:
- 此版本**不包含**退貨過濾
- 建議搭配「排除退貨版」使用

---

#### 📄 代收款誤撥處理/補壓代收請款日_排除退貨版.md ⭐ **最新版**
**用途**: 修正版補壓流程(包含退貨過濾)
**適用對象**: 所有使用者
**內容**:
- 完整的退貨過濾邏輯
- `Detail_Status_Description IN ('買家已取件', '消費者成功取件')`
- 與原版的差異說明

**使用時機**:
- ✅ **未來所有補壓作業都應使用此版本**
- ✅ 避免誤撥退貨訂單

**重要**:
- ⭐ 此為最新修正版
- ⭐ 已修正 2025-10-17 誤撥事件的問題

---

### 3. 事件處理類

#### 📄 代收款誤撥處理/2025-10-17_誤撥退貨訂單事件處理記錄.md
**用途**: 誤撥事件的完整處理記錄
**適用對象**: 財務、會計、開發人員
**內容**:
- 事件背景與根本原因
- 14 個受影響商家清單
- 完整的處理步驟(假性結清、更正撥款、新增欠費)
- 驗證 SQL
- 後續改善措施

**使用時機**:
- 📖 了解誤撥事件的處理流程
- 📖 作為未來類似事件的參考

**學習重點**:
- Grant_History 的假性結清處理
- 多欄位條件的 UPDATE/DELETE
- 撥款金額的更正邏輯

---

## 🔄 工作流程圖

### 日常撥款流程

```
1. 週三凌晨 1:10
   ↓
2. WeeklySettlement 排程執行
   ↓
3. 壓 CheckoutdaisouDate (應包含退貨過濾!)
   ↓
4. 週三白天執行 Grant_AndC2CReport
   ↓
5. 填入 GrantdaisouDate
   ↓
6. 產生 Grant_History 記錄
```

### 補壓流程(核帳檔延遲)

```
1. 發現需要補壓
   ↓
2. 使用「補壓代收請款日_通用流程(會計專用).md」
   ↓
3. 計算日期範圍
   ↓
4. 先用 SELECT 確認筆數
   ↓
5. 執行 UPDATE 補壓
   ↓
6. 驗證結果
   ↓
7. 記錄執行資訊
```

### 誤撥處理流程

```
1. 發現誤撥
   ↓
2. 確認異常訂單範圍
   ↓
3. 檢查假性結清的歷史欠費
   ↓
4. 更正本次正數撥款金額
   ↓
5. 新增本次正確的欠費記錄
   ↓
6. 驗證處理結果
   ↓
7. 記錄事件處理過程
```

---

## 🎯 快速索引

### 我想要...

#### 查詢商家的撥款記錄
→ 使用「查詢_Grant_History撥款與欠費記錄.md」的查詢 1

#### 查詢未結清的欠費
→ 使用「查詢_Grant_History撥款與欠費記錄.md」的查詢 4

#### 手動補壓代收請款日
→ 使用「補壓代收請款日_通用流程(會計專用).md」

#### 了解 Grant_txtName 的意義
→ 參考「查詢_Grant_History撥款與欠費記錄.md」的「Grant_txtName 的三種狀態」

#### 處理誤撥事件
→ 參考「2025-10-17_誤撥退貨訂單事件處理記錄.md」

#### 開發自動化功能
→ 參考「補壓代收請款日_完整步驟.md」+ 「補壓代收請款日_排除退貨版.md」

---

## ⚠️ 重要提醒

### ✅ 執行補壓時務必注意

1. **使用最新版本**: 「補壓代收請款日_排除退貨版.md」或「通用流程(會計專用).md」
2. **包含退貨過濾**: 務必加上 `Detail_Status_Description IN ('買家已取件', '消費者成功取件')`
3. **先 SELECT 後 UPDATE**: 絕對不要直接執行 UPDATE
4. **記錄執行資訊**: 筆數、執行人、執行時間
5. **驗證結果**: 執行後務必驗證更新筆數

### ❌ 常見錯誤

1. 忘記排除退貨 → 會誤撥退貨訂單的代收款
2. 日期範圍算錯 → 會壓到錯誤的訂單
3. 沒有先 SELECT → 直接 UPDATE 可能更新錯誤資料
4. 21 用 CheckoutDate → 21 要用 LogisticProcessHistory.datadatetime

---

## 📞 聯絡資訊

如有問題,請聯絡:
- **系統負責人**: [填寫]
- **技術支援**: [填寫]
- **會計窗口**: [填寫]

---

## 📝 更新記錄

| 日期 | 更新內容 | 負責人 |
|------|---------|--------|
| 2025-10-18 | 建立 README 總覽文件 | Claude |
| 2025-10-18 | 新增「補壓代收請款日_通用流程(會計專用).md」 | Claude |
| 2025-10-18 | 新增「查詢_Grant_History撥款與欠費記錄.md」 | Claude |
| 2025-10-18 | 新增「2025-10-17_誤撥退貨訂單事件處理記錄.md」 | Claude |
| 2025-10-XX | 建立「補壓代收請款日_排除退貨版.md」 | [填寫] |
| 2025-09-XX | 建立「補壓代收請款日_完整步驟.md」 | [填寫] |
