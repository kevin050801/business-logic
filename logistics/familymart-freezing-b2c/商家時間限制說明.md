# 全家冷凍大宗 (24) - 商家時間限制說明

**建立日期**: 2025-10-22
**物流服務**: 全家冷凍大宗 (24)

---

## 🎯 商家疑問

**商家問題**:
> 所以我可以理解成,
>
> ShipDate 是 10/6 的話,
> - 最晚的取號時間,會是 10/9 15:50 (ShipDate+3 15:50) 之前,
> - 最晚的列印標籤時間,會是 10/14 (ShipDate+8)
> - 最晚的出貨時間,會是 10/15 (ShipDate+9)
>
> 超過 10/9 15:50 沒有取號,或者超過 10/14 沒有印標籤,
> 商家就必須重選門市,重新獲取 ReservedNo 跟 ShipDate,才能繼續往下走
>
> 這樣子對嗎?~

---

## ✅ 正確的理解

### 前提說明

**重要**: 商家收到的 ShipDate 根據不同情境有不同意義:

| 商家類型 | 收到的 ShipDate | 實際對應 | 系統驗證基準 |
|---------|----------------|---------|------------|
| **WACA 平台** | 10/6 | OrderDate - 1 = 10/7 - 1 | OrderDate = 10/7 |
| **一般商家** | 10/7 | OrderDate = 10/7 | OrderDate = 10/7 |
| **D+1 商家** | 10/8 | ShipDate + 1 = 10/7 + 1 | OrderDate = 10/7 |

**以下說明以「系統實際 OrderDate = 10/7」為基準進行計算**

---

## 📅 時間限制詳細說明

### 1️⃣ 最晚取號時間

#### 商家理解
- WACA: ShipDate + 3 = 10/6 + 3 = **10/9**
- 一般商家: ShipDate + 3 = 10/7 + 3 = **10/10** ❌ 錯誤

#### 系統實際驗證
**程式碼位置**: `FamiFreezingB2CController.cs:327-332`

```csharp
// ⚠️ 這裡的 ShipDate 實際是 OrderDate
DateTime ShipDate = Convert.ToDateTime(order_FamiFreezing.ShipDate);  // 10/7

if (ShipDate.AddDays(2) < DateTime.Now.Date)  // 10/7 + 2 = 10/9
{
    throw new Exception("物流編號為:" + ShipOrder.LogisticNumber + "的訂單已超過出貨期限 請重新建立訂單");
}
```

**正確答案**:
- 最晚取號日期: **OrderDate + 2 = 10/7 + 2 = 10/9** ✅
- WACA 收到 ShipDate = 10/6,計算為 10/6 + 3 = 10/9 ✅ (巧合相同)
- 一般商家收到 ShipDate = 10/7,應計算為 10/7 + 2 = 10/9 ✅

---

### 2️⃣ 最晚列印標籤時間

#### 商家理解
- WACA: ShipDate + 8 = 10/6 + 8 = **10/14**
- 一般商家: ShipDate + 8 = 10/7 + 8 = **10/15** ❌ 錯誤

#### 系統實際驗證
**程式碼位置**: `OrderController.cs:14057-14089`

##### 情境 A: 首次列印 (IsPrinted = false)

```csharp
if (!order.IsPrinted)
{
    // 最晚列印日期: OrderDate + 2
    if (Convert.ToDateTime(orderStore.OrderDate).AddDays(2) < DateTime.Now.Date)
    {
        print_bulk_order.Error = "物流編號:" + LogisticNumber + "已超過出貨日期";
        goto AddPrint;
    }

    // 當日時間限制: 15:50 前
    if (DateTime.Now.Hour > 15 || (DateTime.Now.Hour == 15 && DateTime.Now.Minute > 50))
    {
        if (DateTime.Now.ToString("yyyy-MM-dd") == Convert.ToDateTime(orderStore.OrderDate).AddDays(2).ToString("yyyy-MM-dd"))
        {
            print_bulk_order.Error = "物流編號:" + LogisticNumber + "已超過出貨時間 無法進行標籤列印";
            goto AddPrint;
        }
    }
}
```

**首次列印期限**:
- 最晚日期: **OrderDate + 2 = 10/7 + 2 = 10/9**
- 時間限制: **15:50 前**
- **10/9 15:50** 是最後可首次列印的時間 ✅

##### 情境 B: 重複列印 (IsPrinted = true)

```csharp
else
{
    // 已列印過,可以重複列印到 ShipDate + 6
    if (Convert.ToDateTime(orderStore.ShipDate).AddDays(6) < DateTime.Now.Date)
    {
        print_bulk_order.Error = "物流編號:" + LogisticNumber + "已超過出貨日期";
        goto AddPrint;
    }
}
```

**重複列印期限**:
- 最晚日期: **ShipDate + 6 = 10/8 + 6 = 10/14** ✅
- WACA 計算: 10/6 + 8 = 10/14 ✅ (巧合相同)

**正確答案**:
- **首次列印**: OrderDate + 2 = 10/9 15:50 前 ✅
- **重複列印**: ShipDate + 6 = 10/14 ✅
- ⚠️ **必須先在 10/9 15:50 前完成首次列印,才能保留到 10/14 重複列印**

---

### 3️⃣ 最晚出貨時間

#### 商家理解
- ShipDate + 9 = **10/15** ❓

#### 系統實際情況

**查無明確的「最晚出貨時間」驗證**

系統中沒有找到直接驗證「最晚出貨時間」的程式碼。但從以下邏輯可推斷:

1. **列印標籤後即可出貨**
2. **最晚列印時間決定最晚出貨時間**

**推測**:
- 如果 **10/9 15:50 前完成首次列印**,理論上可在 **10/14** 前出貨
- 但實際的「出貨」是指「商家寄送給全家」,只要在 **OrderDate (10/7)** 前後幾天內寄出即可

**結論**: ❌ **系統沒有明確的「最晚出貨時間」限制**

---

### 4️⃣ 保留編號過期

#### 系統自動取消保留空間

**排程時間**: 每天 **02:45**

**程式碼位置**: `Startup.cs:1378-1383`

```csharp
public static void FamiFreezingCancelSpace()
{
    Cls_FamiFreezingB2C cls_FamiFreezingB2C = new Cls_FamiFreezingB2C();
    RecurringJob.AddOrUpdate("FamiFreezingCancelSpace", () => cls_FamiFreezingB2C.CancelSpace(),
        "45 02 * * *", TimeZoneInfo.Local);  // 每天 02:45 執行
}
```

**取消條件** (Sel_CancelSpaceStore 預存程序):

```sql
-- 條件 1: 未建單的保留編號,超過 OrderDate - 3 天
Select * from OrderStoreID
where NOT EXISTS(
    select LogisticNumber from FamiFreezingB2COrder
    where FamiFreezingB2COrder.ReservedNo=OrderStoreID.ReservedNo
)
and OrderDate < DATEADD(DAY, -3, GETDATE())
and Flag='0'
and Logistic_service='24'

UNION

-- 條件 2: 已建單但未列印,超過 OrderDate - 8 天
Select * from OrderStoreID
where EXISTS(
    Select user_account, orderno from Order_Info
    Where Order_Info.LogisticNumber=OrderStoreID.orderno
    and Logistic_service='24'
    and IsPrinted='0'
)
and OrderDate < DATEADD(DAY, -8, GETDATE())
and Flag='0'
```

**自動取消時間**:
- **未建單**: OrderDate - 3 天後,在每天 **02:45** 自動取消
  - OrderDate = 10/7 → **10/10 02:45** 會被取消
- **已建單未列印**: OrderDate - 8 天後,在每天 **02:45** 自動取消
  - OrderDate = 10/7 → **10/15 02:45** 會被取消

---

## 📊 完整時間軸 (以 WACA 收到 ShipDate = 10/6 為例)

```
10/6 (WACA 收到 ShipDate)
  ├─ ✅ 可以選店
  ├─ ✅ 可以建單
  ├─ ✅ 可以取號
  └─ ✅ 可以列印標籤

10/7 (實際 OrderDate - 全家上收日)
  └─ 全家派車到商家收貨

10/8 (實際 ShipDate - DC出貨日)
  └─ 貨物到達全家物流中心

10/9 15:50
  ├─ ❌ 最晚取號時間 (OrderDate + 2)
  └─ ❌ 最晚首次列印時間 (OrderDate + 2)

10/10 02:45
  └─ ⚠️ 未建單的保留編號會被系統自動取消

10/14
  └─ ❌ 最晚重複列印時間 (ShipDate + 6)
     (前提: 必須在 10/9 15:50 前完成首次列印)

10/15 02:45
  └─ ⚠️ 已建單但未列印的保留編號會被系統自動取消
```

---

## ✅ 修正後的正確理解

### 以 WACA 平台為例 (收到 ShipDate = 10/6)

| 項目 | 商家理解 | 系統實際 | 是否正確 |
|------|---------|---------|---------|
| **最晚取號時間** | ShipDate + 3 = 10/9 | OrderDate + 2 = 10/9 | ✅ 結果相同 |
| **最晚首次列印** | - | OrderDate + 2 = 10/9 15:50 | ⚠️ 需補充 |
| **最晚重複列印** | ShipDate + 8 = 10/14 | ShipDate + 6 = 10/14 | ✅ 結果相同 |
| **最晚出貨時間** | ShipDate + 9 = 10/15 | ❌ 無此限制 | ❌ 不存在 |
| **保留編號取消(未建單)** | - | OrderDate - 3 天後的 02:45 = 10/10 02:45 | ⚠️ 需補充 |
| **保留編號取消(已建單)** | - | OrderDate - 8 天後的 02:45 = 10/15 02:45 | ⚠️ 需補充 |

### 以一般商家為例 (收到 ShipDate = 10/7)

| 項目 | 商家可能理解 | 系統實際 | 是否正確 |
|------|------------|---------|---------|
| **最晚取號時間** | ShipDate + 3 = 10/10 ❌ | OrderDate + 2 = 10/9 | ❌ 錯誤 |
| **最晚首次列印** | - | OrderDate + 2 = 10/9 15:50 | - |
| **最晚重複列印** | ShipDate + 8 = 10/15 ❌ | ShipDate + 6 = 10/14 | ❌ 錯誤 |

---

## 🎯 正確的時間計算公式

### 通用公式 (適用所有商家類型)

| 項目 | 計算公式 | 說明 |
|------|---------|------|
| **最晚建單** | OrderDate + 2 | 建單和取號共用期限 |
| **最晚取號** | OrderDate + 2 | 10/7 + 2 = 10/9 |
| **最晚首次列印** | OrderDate + 2 15:50 | 10/7 + 2 = 10/9 15:50 |
| **最晚重複列印** | ShipDate + 6 | 10/8 + 6 = 10/14 (需先完成首次列印) |
| **保留編號取消(未建單)** | OrderDate - 3 天後的 02:45 | 10/7 - 3 = 10/10 02:45 |
| **保留編號取消(已建單未印)** | OrderDate - 8 天後的 02:45 | 10/7 - 8 = 10/15 02:45 |

### WACA 平台的換算 (僅供參考)

WACA 收到的 ShipDate = OrderDate - 1,因此:

| 項目 | WACA 換算公式 | 等同於 |
|------|-------------|-------|
| 最晚取號 | (ShipDate + 1) + 2 = ShipDate + 3 | 10/6 + 3 = 10/9 ✅ |
| 最晚首次列印 | (ShipDate + 1) + 2 = ShipDate + 3 | 10/6 + 3 = 10/9 15:50 ✅ |
| 最晚重複列印 | (ShipDate + 2) + 6 = ShipDate + 8 | 10/6 + 8 = 10/14 ✅ |

**注意**: 雖然 WACA 的換算結果碰巧正確,但建議商家統一使用系統實際的計算基準 (OrderDate),避免混淆。

---

## 🚨 商家必須重選門市的情況

### 情況 1: 超過取號期限

**條件**: 超過 **OrderDate + 2 (10/9)** 未取號

**結果**:
- 取號 API 會拋錯: "已超過出貨期限 請重新建立訂單"
- **必須重選門市**,重新獲取新的 ReservedNo 和新的 OrderDate

### 情況 2: 超過首次列印期限

**條件**: 超過 **OrderDate + 2 15:50 (10/9 15:50)** 未首次列印

**結果**:
- 列印 API 會拋錯: "已超過出貨時間 無法進行標籤列印"
- **必須重選門市**,重新獲取新的 ReservedNo 和新的 OrderDate

### 情況 3: 保留編號被系統取消

**條件**:
- 未建單: **OrderDate - 3 天** 後的每天 **02:45** 會被取消
- 已建單未印: **OrderDate - 8 天** 後的每天 **02:45** 會被取消

**結果**:
- 保留編號失效 (Flag 被設為 1)
- **必須重選門市**,重新獲取新的 ReservedNo 和新的 OrderDate

### 情況 4: 超過重複列印期限

**條件**: 已首次列印,但超過 **ShipDate + 6 (10/14)** 需要重複列印

**結果**:
- 列印 API 會拋錯: "已超過出貨日期"
- **必須重選門市**,重新獲取新的 ReservedNo 和新的日期

---

## 💡 給商家的建議

### ✅ 最佳流程

```
收到 ShipDate 當天
  ├─ 立即建單 (Add_Order)
  ├─ 立即取號 (ShipFamiB2Cpaymentno)
  └─ 立即列印標籤 (PrintFamiFreezingB2CLabel)

建議在 OrderDate 當天或前一天出貨
```

### ⚠️ 關鍵時間點

1. **10/9 15:50** 是最關鍵的時間點:
   - 必須在此時間前完成「取號」和「首次列印」
   - 超過此時間未完成,就必須重選門市

2. **10/9 15:50 前完成首次列印** 可以:
   - 保留到 **10/14** 重複列印標籤
   - 但仍建議盡早出貨

3. **避免拖到最後期限**:
   - 盡量在 OrderDate 前後出貨
   - 不要等到 10/9 才開始處理

---

## 📝 總結

### 商家原理解的問題

| 項目 | 原理解 | 實際情況 | 問題 |
|------|-------|---------|------|
| 最晚取號 | ShipDate + 3 | OrderDate + 2 | WACA 碰巧正確,其他商家會錯 |
| 最晚列印 | ShipDate + 8 | 首次: OrderDate + 2 15:50<br>重複: ShipDate + 6 | 公式錯誤,且未區分首次/重複 |
| 最晚出貨 | ShipDate + 9 | ❌ 無此限制 | 不存在此限制 |

### 正確的理解

1. ✅ **超過 10/9 15:50 沒有取號或首次列印** → 必須重選門市
2. ✅ **需要重新獲取 ReservedNo** → 重選門市會得到新的保留編號
3. ✅ **需要重新獲取 OrderDate/ShipDate** → 重選門市會得到新的日期
4. ✅ **如果 10/9 15:50 前完成首次列印** → 可保留到 10/14 重複列印
5. ❌ **最晚出貨時間 (ShipDate + 9)** → 系統無此限制

---

**維護紀錄**:
- ✅ 已確認所有時間限制的程式碼邏輯
- ✅ 已確認排程取消保留空間的時間 (02:45)
- ✅ 已確認首次列印和重複列印的不同期限
- ✅ 已確認無「最晚出貨時間」限制
