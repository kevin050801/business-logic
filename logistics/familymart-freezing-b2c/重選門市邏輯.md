# 全家冷凍大宗 (24) - 重選門市邏輯

**建立日期**: 2025-10-22
**物流服務**: 全家冷凍大宗 (24)
**適用對象**: 已選店但需要更換門市的商家

---

## 📌 重選門市觸發情境

### 什麼時候需要重選門市?

1. **消費者要求更改收貨門市**
2. **原門市空間已滿無法收貨**
3. **訂單尚未出貨,需要變更門市**

### 重選門市的限制條件

**可以重選**:
- ✅ 已選店但未建單 (只有保留編號)
- ✅ 已建單但未取號
- ✅ 已取號但未出貨
- ✅ 貨態為 8001 (退貨成功)

**不可重選**:
- ❌ 訂單正在上傳中 (Detail_Status = 1000)
- ❌ 已驗收 (respcode = 4000)

---

## 🔄 重選門市流程

### 流程一: API 觸發重選門市

**API 端點**: `POST /Member/Order/ReStoreID`

#### 請求參數

| 參數 | 必填 | 說明 |
|------|------|------|
| user_account | ✅ | 商家主帳號 |
| apicode | ✅ | 商家 API 密碼 |
| returnUrl | ✅ | 店號回傳網址 (≤200字元) |
| ReservedNo | ✅ | 原保留編號 |
| Logistic_serviceID | ✅ | 物流服務代碼 (24) |
| Length | ✅ | 包裹長度 (cm) |
| Wide | ✅ | 包裹寬度 (cm) |
| High | ✅ | 包裹高度 (cm) |
| StartDate | ✅ | 出貨日期起 |
| EndDate | ✅ | 出貨日期迄 |
| Weight | ❌ | 包裹重量 (kg) |
| LogisticNumber | ❌ | PayNow 訂單編號 (已建單時必填) |
| Ecplateform | ❌ | 電商平台識別 (如: WACA) |

#### 驗證邏輯

**程式碼位置**: `OrderController.cs:1813-2042`

```csharp
// 1. 驗證商家帳號與 API 密碼
mem = cls_member.Sel_member_apicode(user_account, apicode);

// 2. 用保留編號查詢前置檔
order_storeid = cls_order.Sel_OrderStoreID(ReservedNo, user_account, mem.sonid, "24");

// 3. 檢查是否已建立訂單
Object_Order obj_order = cls_order.Sel_Order(order_storeid.orderno);

// 4. 驗證訂單狀態
if (obj_order.paymentno.Length == 11)  // 已取號
{
    // 檢查是否正在上傳
    if (obj_order.Detail_Status == "1000")
        throw new Exception("訂單正在上傳中無法重選店鋪");

    // 檢查是否退貨成功
    if (obj_order.Detail_Status != "8001")
    {
        // 檢查是否已驗收
        Dt = cls_order.Sel_LogisticProcessHistory(LogisticNumber, obj_order.paymentno);
        DataRow[] SelectDtGrant = Dt.Select("respcode='4000'");
        if (SelectDtGrant.Length > 0)
            throw new Exception("此訂單已經驗收無法重選店鋪");
    }
}

// 5. 檢查保留空間狀態
if (order_storeid.Flag == "0")  // 已確認空間
    throw new Exception("請先將店鋪空間取消");

if (order_storeid.Flag == "2")  // 已預約空間
    cls_FamiFreezingB2C.SpaceConfirm(ReservedNo, "1");  // 取消空間
```

**驗證通過後的處理** (OrderController.cs:1961-2024):

```csharp
// 1. 重新驗證材積
Obj_MapParam obj_MapParam = cls_FamiFreezingB2C.Validate_FamiFreezingMap(
    user_account, mem.sonid, Weight, Length, Wide, High, StartDate, EndDate
);

// 2. 組裝電子地圖參數 (urltype = 03)
CvsTemp = TripleDesUserAccount + "," +
          mem.sonid + ",03," +
          order_storeid.orderno + "," +
          ReservedNo + "," +
          obj_MapParam.NumWeight + "," +
          obj_MapParam.NumLength + "," +
          obj_MapParam.NumWidth + "," +
          obj_MapParam.NumHeight + "," +
          obj_MapParam.StartDate + "," +
          obj_MapParam.EndDate + "," +
          Ecplateform;

// 3. 跳轉到全家電子地圖重新選店
// Exchange = "true" 表示重選店
```

---

### 流程二: 電子地圖回傳新門市 (urltype = 03)

**端點**: `POST /Member/Order/GetFamiFreezingStoreid`

#### CvsTemp 參數解析

**格式** (temp.Length = 12):

```
temp[0]  = user_account (加密)
temp[1]  = sonid
temp[2]  = urltype = "03"
temp[3]  = orderno
temp[4]  = PastReservedNo (舊保留編號)
temp[5]  = NumWeight
temp[6]  = NumLength
temp[7]  = NumWidth
temp[8]  = NumHeight
temp[9]  = StartDate
temp[10] = EndDate
temp[11] = Ecplateform (如: WACA)
```

**程式碼位置**: `OrderController.cs:1042-1066`

---

### 流程三: 更新門市資料

**程式碼位置**: `OrderController.cs:1121-1225`

#### 情境 A: 已建單且已取號

```csharp
// 1. 重新驗證材積
obj_MapParam = cls_FamiFreezingB2C.Validate_FamiFreezingMap(
    obj_MapTemp.user_account, obj_MapTemp.sonid,
    obj_MapTemp.NumWeight, obj_MapTemp.NumLength,
    obj_MapTemp.NumWidth, obj_MapTemp.NumHeight,
    obj_MapTemp.StartDate, obj_MapTemp.EndDate
);

// 2. 查詢材積費用 (材積可能改變)
Obj_VolumeServiceFee Obj_ServiceFee = cls_order.Sel_VolumeServiceFee(
    obj_MapTemp.user_account, obj_MapTemp.sonid, "24", volume, 0
);

// 3. 查詢子訂單
obj_Freezing = cls_FamiFreezingB2C.Sel_FamiFreezingB2C(obj_MapTemp.orderno);

// 4. 重新取號 (因為門市變更)
NewOrderNo = cls_FamiFreezingB2C.Sel_FamiFreezingB2CMinOrderno(
    DateTime.Now.ToString("yyyy"),
    obj_MapTemp.user_account,
    obj_MapTemp.sonid,
    obj_Freezing.LogisticNumber,
    obj_Freezing.sno,
    ParentId,
    obj_Freezing.EshopId
);

// 5. 如果材積不同,更新物流費
if (Measurement != obj_Freezing.Measurement)
{
    cls_order.Up_OrderinfoCost(obj_Freezing.LogisticNumber,
                               Obj_ServiceFee.Cost,
                               Obj_ServiceFee.Service_fee);
}

// 6. 更新所有相關資料
Up_ReStoreFile = cls_FamiFreezingB2C.Up_ReStoreFile(
    mapData, obj_MapTemp, obj_Freezing.LogisticNumber,
    NewOrderNo, ParentId, obj_Freezing.EshopId,
    Measurement, order_storeID.ReturnUrl,
    Convert.ToBoolean(order_storeID.ReturnOrderno), "2"
);
```

**Up_ReStoreFile 更新的資料表** (Cls_FamiFreezingB2C.cs:2273-2368):

1. **Order_Info** (主訂單表):
   ```sql
   Update Order_Info set
       Weight=@Weight,
       Length=@Length,
       Width=@Width,
       Height=@Height,
       receiver_storeid=@receiver_storeid,
       paymentno=@paymentno,
       receiver_storename=@receiver_storename,
       IsPrinted='0',      -- 重置列印狀態
       IsShipping='0',     -- 重置出貨狀態
       ShipDate = null     -- 清除出貨日期
   where LogisticNumber=@LogisticNumber
   ```

2. **FamiFreezingB2COrder** (子訂單表):
   ```sql
   EXEC Up_FamiFreezingB2COrder_ReservedNo
       @LogisticNumber,
       @OrderNo,           -- 新的配送編號
       @user_account,
       @ParentId,
       @EshopId,
       @ReservedNo,        -- 新的保留編號
       @Measurement,
       @ShipDate,          -- 使用新的 OrderDate
       @ReceiverStoreId
   ```

3. **OrderStoreID** (前置檔 - 使用舊保留編號更新):
   ```sql
   EXEC Up_OrderStoreID_Volume
       @user_account,
       @ReservedNo = PastReservedNo,  -- 使用舊保留編號
       @Weight,
       @Length,
       @Width,
       @Height,
       @StartDate,
       @EndDate
   ```

4. **OrderStoreID** (前置檔 - 使用訂單編號更新):
   ```sql
   EXEC Up_OrderStoreID
       @user_account,
       @orderno,
       @Logistic_service = '24',
       @StoreID,           -- 新門市代碼
       @StoreName,         -- 新門市名稱
       @StoreAddress,      -- 新門市地址
       @returnUrl,
       @ReturnOrderno,
       @OrderDate,         -- 新的上收日
       @ShipDate,          -- 新的 DC 出貨日
       @ReservedNo,        -- 新的保留編號
       @Flag = '2'
   ```

---

#### 情境 B: 僅選店未建單

```csharp
// 只需更新前置檔
// 1. 更新店鋪檔材積
UpVolume = cls_order.Up_OrderStoreID_Volume(
    obj_MapTemp.user_account,
    obj_MapTemp.PastReservedNo,  // 使用舊保留編號
    obj_MapTemp.NumWeight,
    obj_MapTemp.NumLength,
    obj_MapTemp.NumWidth,
    obj_MapTemp.NumHeight,
    obj_MapTemp.StartDate,
    obj_MapTemp.EndDate
);

// 2. 更新店鋪資料
returnstr = cls_order.Up_OrderStoreID(
    obj_MapTemp.orderno,
    obj_MapTemp.user_account,
    obj_MapTemp.sonid,
    "24",
    mapDataDetail.StoreId,    // 新門市
    mapDataDetail.Name,       // 新門市名稱
    mapDataDetail.Addr,       // 新門市地址
    order_storeID.ReturnUrl,
    Convert.ToBoolean(order_storeID.ReturnOrderno),
    mapItemDetail.OrderDate,  // 新的上收日
    mapItemDetail.ShipDate,   // 新的 DC 出貨日
    mapItemDetail.ReservedNo, // 新的保留編號
    "2"                       // Flag = 2 (已預約)
);
```

---

## 📋 重選門市後的狀態變化

### 資料庫狀態變化

| 項目 | 重選前 | 重選後 |
|------|--------|--------|
| **OrderStoreID.ReservedNo** | 舊保留編號 | 新保留編號 |
| **OrderStoreID.StoreID** | 舊門市代碼 | 新門市代碼 |
| **OrderStoreID.StoreName** | 舊門市名稱 | 新門市名稱 |
| **OrderStoreID.StoreAddress** | 舊門市地址 | 新門市地址 |
| **OrderStoreID.OrderDate** | 舊上收日 | 新上收日 |
| **OrderStoreID.ShipDate** | 舊 DC 出貨日 | 新 DC 出貨日 |
| **OrderStoreID.Flag** | 0 or 2 | 2 (已預約) |
| **Order_Info.receiver_storeid** | 舊門市代碼 | 新門市代碼 |
| **Order_Info.receiver_storename** | 舊門市名稱 | 新門市名稱 |
| **Order_Info.paymentno** | 舊配送編號 | 新配送編號 (已取號時) |
| **Order_Info.IsPrinted** | 0 or 1 | 0 (重置) |
| **Order_Info.IsShipping** | 0 or 1 | 0 (重置) |
| **Order_Info.ShipDate** | 原出貨日 | null (清除) |
| **FamiFreezingB2COrder.ReservedNo** | 舊保留編號 | 新保留編號 |
| **FamiFreezingB2COrder.OrderNo** | 舊配送編號 | 新配送編號 (已取號時) |
| **FamiFreezingB2COrder.ReceiverStoreId** | 舊門市代碼 | 新門市代碼 |
| **FamiFreezingB2COrder.ShipDate** | 舊 OrderDate | 新 OrderDate |
| **FamiFreezingB2COrder.Measurement** | 舊材積 | 新材積 (可能改變) |

### 重要提醒

1. **舊保留編號的空間會被取消** (`SpaceConfirm(ReservedNo, "1")`)
2. **新保留編號的空間會自動預約** (Flag = 2)
3. **已取號的訂單會重新取號** (配送編號改變)
4. **列印和出貨狀態會重置** (需重新列印標籤)
5. **材積改變時會更新物流費用**

---

## 🔄 空間取消 API

**API**: 全家 ShopSpaceConfirm API

**端點**: `/ShopSpaceConfirm/ShopSpaceConfirm.ashx`

**程式碼位置**: `Cls_FamiFreezingB2C.cs:1560-1640`

### 請求參數

```xml
<?xml version="1.0" encoding="UTF-8"?>
<Doc>
  <ReservedNos>
    <ReservedNo>保留編號</ReservedNo>
    <Flag>1</Flag>  <!-- 0:確認 1:取消 -->
  </ReservedNos>
</Doc>
```

### Flag 說明

| Flag | 說明 | 用途 |
|------|------|------|
| 0 | 確認空間 | 確定要使用此保留空間 |
| 1 | 取消空間 | 釋放保留空間 |

### 回傳錯誤碼處理

| ErrorCode | ErrorMessage | 系統處理 |
|-----------|-------------|---------|
| 000 | 成功 | 返回 "S" |
| 102 | 此單已作廢 | Flag=0 時拋錯,Flag=1 時返回 "S" |
| 022 | 不可重覆取消 | 返回 "S" |
| 023 | 不可重覆確認 | 返回 "S" |
| 其他 | 錯誤訊息 | 拋出例外 |

---

## 🎯 重選門市的時間限制

### 可重選的時間範圍

重選門市的時間限制與原訂單的 OrderDate 相關:

```
原訂單 OrderDate = 10/7

可重選期間:
- 10/6 (OrderDate - 1) 開始可以重選
- 10/9 (OrderDate + 2) 15:50 前必須完成重選
- 10/10 開始 API 會拋錯
```

**注意**:
- 重選後會得到新的 OrderDate
- 新的 OrderDate 必須符合全家的配送日規則
- WACA 平台收到的 ShipDate 仍然會 -1 天

---

## 🚨 常見錯誤與處理

### 錯誤 1: 訂單正在上傳中無法重選店鋪

**原因**: Detail_Status = 1000 (訂單正在上傳 FTP)
**解決**: 等待上傳完成後再重選

### 錯誤 2: 此訂單已經驗收無法重選店鋪

**原因**: 消費者已取貨驗收 (respcode = 4000)
**解決**: 無法重選,需重新建立訂單

### 錯誤 3: 請先將店鋪空間取消

**原因**: OrderStoreID.Flag = 0 (空間已確認)
**解決**: 系統應自動呼叫 SpaceConfirm(ReservedNo, "1") 取消空間

### 錯誤 4: 物流編號為:XXX 的店鋪空間未保留

**原因**: OrderStoreID.Flag != 0 (空間未保留或已取消)
**解決**: 檢查原保留編號是否過期或被取消

### 錯誤 5: PayNow 訂單編號與保留編號不同

**原因**: 傳入的 LogisticNumber 與資料庫不符
**解決**: 使用正確的 LogisticNumber

---

## 📊 重選門市時間軸範例

### 情境: 10/6 選店,10/7 需要重選

```
10/6 10:00
  └─ 初次選店 (ReservedNo: A123456789)
     - OrderDate = 10/7
     - ShipDate = 10/8

10/7 14:00
  └─ 消費者要求更換門市
     - 呼叫 ReStoreID API
     - 系統取消舊保留編號空間
     - 跳轉全家電子地圖重新選店

10/7 14:05
  └─ 選擇新門市完成 (ReservedNo: B987654321)
     - 新 OrderDate = 10/8
     - 新 ShipDate = 10/9
     - urltype = 03 回傳到 GetFamiFreezingStoreid

10/7 14:06
  └─ 系統更新資料
     ├─ 更新 OrderStoreID (新門市、新保留編號、新日期)
     ├─ 更新 Order_Info (重置列印狀態)
     ├─ 更新 FamiFreezingB2COrder (重新取號)
     └─ 回傳新資料給商家

10/8
  └─ 全家派車到商家收貨 (使用新 OrderDate)

10/9
  └─ 貨物到達全家物流中心 (新 ShipDate)
```

---

## 💻 相關程式碼位置

| 功能 | 檔案 | 行數 | 說明 |
|------|------|------|------|
| 重選門市 API | OrderController.cs | 1813-2042 | ReStoreID 方法 |
| 電子地圖回傳 (urltype=03) | OrderController.cs | 1042-1066 | CvsTemp 解析 |
| 已取號的重選處理 | OrderController.cs | 1121-1225 | 重新取號 + 更新資料 |
| 未建單的重選處理 | OrderController.cs | 1206-1224 | 只更新前置檔 |
| 更新所有相關資料 | Cls_FamiFreezingB2C.cs | 2273-2368 | Up_ReStoreFile |
| 空間取消 API | Cls_FamiFreezingB2C.cs | 1560-1640 | SpaceConfirm |
| 重新取號 | Cls_FamiFreezingB2C.cs | - | Sel_FamiFreezingB2CMinOrderno |

---

**文件維護**:
- ✅ 已確認重選門市完整流程
- ✅ 已確認兩種情境 (已取號/未建單)
- ✅ 已確認空間取消邏輯
- ✅ 已確認資料表更新範圍
